---
title: "Analysis of Reef Restoration:"
subtitle: "A Collaboration with Bonaire Reef Renewal Foundation"
author: "Tadge McWilliams"
date: "2023-03-30"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r, load libraries, include=FALSE, echo=FALSE}
library(readxl)
library(tidyverse)
library(pander)
```
The goal of this project is to aid the Bonaire Reef Renewal Foundation in developing a successful, data driven program through which to efficiently introduce new, "reef-ready" corals into the Bonaire reef systems.  By analyzing the survey data from multiple coral reef outplanting locations, I attempt to provide insights into the viability of each genotype and the overall changes in the ecological footprints of the outplanting locations.

## Carl's Hill

The summary statistics below were generated from a survey of coral growth between April 11th, 2021 and May 4th, 2021, approximately three months after the initial outplanting of new, "reef-ready" corals at Carl's Hill.  
Geno #16 and geno #7 appear to have negative mortality rates.  These statistics were caused when more observations were recorded during the 3-month survey than were originally outplanted.  It is unknown if this was caused by a division of the previously outplanted corals or a survey error.

```{r, carls hill data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))
```

*Ranking Genotypes by Mortality Rate*
```{r, carls hill calculating coral losses by geno, echo=FALSE, message=FALSE}
carl_losses <- carl3 %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
    arrange(desc(mortality_rate))

carl_losses$mortality_rate <- paste0(round(carl_losses$mortality_rate, 2), "%")
carl_losses %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate) %>%
  pander()
```

Another feature of the survey is to record the percentage of healthy coral tissue for each observation.  Predation, disease, and other environmental factors can be detrimental to coral growth.  Below, I have created a weighted average of tissue health by genotype.  I should note that weighted average of tissue health does include the observations that were pronounced dead.  Therefore, the average health of each geno takes into account the mortality rate of that geno as well as the average health of the living observations.  

*Ranking Genotypes by Average Tissue Health*
```{r, carls hill calculating weighted coral health by geno, echo=FALSE}
carl_health <- carl3 %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.375, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.625, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.875, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health0 + Health25 + Health50 + Health75 + 
                           Health99 + Health100, na.rm = TRUE) / n_present) * 100) 

carl_health_agg <- carl_health %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))


### Table of net losses and weighted health by geno
loss_health_table <- carl_losses %>%
  inner_join(carl_health_agg, by = "geno") %>%
  select(species, geno, avg_health, mortality_rate) %>%
  arrange(desc(avg_health)) 
loss_health_table$avg_health <- paste0(round(loss_health_table$avg_health, 2), "%")
loss_health_table %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
  pander()
```


Outliers can easily skew the averages of any aggregate summary.  The plot below identifies the range of tissue health by genotype.  While the average tissue health of genos #1, #5, and #9 is slightly depressed from a few poorly performing outliers, it appears that genos #14, #16, #18, #19, and #22 are generally less resilient than the others.

```{r, carls hill boxplot of tissue health by geno, echo=FALSE}
ggplot(carl_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(35, 100), breaks = seq(35, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       title = "Carl's Hill 3-Month Survey",
       caption = "Adj. Survey Date: 2022-04-27")
```

Actionable Opportunities:
There are a variety of stressors that are detrimental to the success of coral growth.  The majority of these, especially desease and predation, are out of the control of the foundation.  Bottom contract--a stressor caused from agitation against the seafloor--is typically when corals break free from their placements.  While this is unavoidable during tropical storms or wind-reversals, there is an opportunity reduce the amount of overall bottom contract events with stronger adhesives.   

```{r, bottom stressor proportion, echo=FALSE}
bottom_perc <- carl3 %>%
  summarize(Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Percent_of_Total = (sum(carl3$bottom_contact, na.rm = TRUE) / 
                sum(carl3$n_stressors, na.rm = TRUE) * 100))

bottom_perc$Percent_of_Total <-paste0(round(bottom_perc$Percent_of_Total, 2), "%")
bottom_perc %>% rename("Bottom Contact" = Bottom_Contact,
                       "Total Stressors" = Total_Stressors,
                       "Precent of Total" = Percent_of_Total) %>%
  pander()
```


## Yellowman
Copy 

### Yellowman A
Yellow man A copy.
```{r, yellowman data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
yellowman3A <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor"))

yellowman6A <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor"))
```

*3-Month Survey: Ranking Genotypes by Mortality Rate*
```{r yellowman3 calculating coral losses by geno, echo=FALSE, message=FALSE}
yellowman_losses3A <- yellowman3A %>%
  group_by(species, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present),
            mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
  arrange(desc(mortality_rate))

yellowman_losses3A$mortality_rate <- paste0(round(yellowman_losses3A$mortality_rate, 2), "%")
yellowman_losses3A %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate) %>%
  pander()
```

*Ranking Genotypes by Average Tissue Health*
```{r, yellowman3A calculating 3A weighted coral health by geno, echo=FALSE }
yellowman_health3A <- yellowman3A %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.375, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.625, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.875, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health0 + Health25 + Health50 + Health75 + 
                                 Health99 + Health100, na.rm = TRUE) / n_present) * 100)

yellowman_health_agg3A <- yellowman_health3A %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))

yellowman_loss_health_table3A <- yellowman_losses3A %>%
  inner_join(yellowman_health_agg3A, by = "geno") %>%
  select(species, geno, avg_health, mortality_rate) %>%
  arrange(desc(avg_health)) 

yellowman_loss_health_table3A$avg_health <- paste0(round(yellowman_loss_health_table3A$avg_health, 2), "%")
yellowman_loss_health_table3A %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
  pander()
```

The plot below identifies the range of tissue health by genotype
```{r, yellowman3A boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowman_health3A, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(35, 100), breaks = seq(35, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       title = "Yellowman A",
       subtitle = "3-Month Survey",
       caption =  "Adj. Survey Date: 2021-06-23")
```

### Yellowman B
Yellowman B Copy