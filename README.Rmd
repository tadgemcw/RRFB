---
title: "Analysis of Coral Restoration Efforts"
subtitle: "In Collaboration with Bonaire Reef Renewal Foundation"
author: "Tadge McWilliams"
date: "April 26th, 2023"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r, load libraries, include=FALSE, echo=FALSE}
library(readxl)
library(tidyverse)
library(pander)
```

## Introduction
The goal of this project is to assist [Bonaire Reef Renewal Foundation](https://www.reefrenewalbonaire.org) in developing a successful, data driven program through which to efficiently introduce new, "reef-ready" corals into Bonaire's reef systems.  By analyzing survey data from multiple coral reef outplanting locations, I attempt to provide insights into the viability of two coral species, their genotypes, and the overall changes in the ecological footprints of the outplanting locations.  The following analysis is intended to adhear to the guidence proposed by NOAA in its September 2020 technical memorandum *Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local Ecosystem Scales.*

## Species: Apal
### Carl's Hill 3-Month Survey
The summary statistics below were generated from a survey of coral health between April 11th, 2021 and May 4th, 2021, approximately three months after the initial outplanting of corals at Carl's Hill.  Note that Genos #16 and #7 appear to have negative mortality rates.  These statistics were caused because more observations were recorded during the 3-month survey than were originally outplanted.  It is unknown if this was caused by a division of the previously outplanted corals or a survey error.

Apart from the mortality rate, an important universal metric included in the survey is to record the percentage of healthy coral tissue for each observation.  Predation, disease, and other environmental factors are detrimental to coral growth.  Below, I have created a weighted average of tissue health by genotype.  I should note that the weighted average of tissue health does not include dead observations. [^1]

[^1]: Goergen, E.A., Schopmeyer, S., Moulding, A.L., Moura, A., Kramer, P., and Viehman, T.S. 2020. Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local to Ecosystem Scales. NOAA Technical Memorandum NOS NCCOS 279. Silver Spring, MD. 158 pp. https://doi.org/10.25923/xndz-h538


```{r, carls hill 3 data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))
```


```{r, carls hill 3 mortality rate, echo=FALSE, message=FALSE}
carl_losses3 <- carl3 %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
    arrange(desc(mortality_rate))

carl_losses3$mortality_rate <- paste0(round(carl_losses3$mortality_rate, 2), "%")
```


**Carl's Hill 3-Month Survey: Ranking Genotypes by Average Tissue Health**
```{r, carls hill calculating weighted coral health by geno, echo=FALSE}
carl_health <- carl3 %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

carl_health_agg <- carl_health %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))


### Table of net losses and weighted health by geno
carl3_loss_health_table <- carl_losses3 %>%
  inner_join(carl_health_agg, by = "geno") %>%
  arrange(desc(avg_health)) 

carl3_loss_health_table_pretty <- carl3_loss_health_table
carl3_loss_health_table_pretty$avg_health <- paste0(round(carl3_loss_health_table_pretty$avg_health, 2), "%")


carl3_loss_health_table_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
pander()
```


Outliers can easily skew the averages of an aggregate summary.  The plot below identifies the range of tissue health by genotype.  While the average tissue health of genos #1, #9, and #21 is slightly depressed from a few poorly performing outliers, it appears that genos #14, #16, #18, #19, and #22 are generally less resilient than the others.

**Carl's Hill 3-Month Survey: Average Tissue Health Variance**
```{r, carls hill boxplot of tissue health by geno, echo=FALSE}
ggplot(carl_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       caption = "Adj. Survey Date: 2022-04-27")
```

### Carl's Hill 6-Month Survey
The following data was taken three months later in a survey conducted on July 4th, 2022. 

```{r, carls hill 6 month survey data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
carl6 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 3, 
                    range = 'A2:Z51',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cyanob", "sedimentation", "unknown", "n_stressors"))
```



```{r carls hill 6 month mortality rate, echo=FALSE, message=FALSE}
carl6_losses <- carl6 %>%
  group_by(species, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present),
            mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
  arrange(desc(mortality_rate))
```

**Carl's Hill 6-Month Survey: Ranking Genotypes by Average Tissue Health**
```{r carls hill 6 month weighted health, echo=FALSE}
### Calculating weighted coral health by geno
carl6_health <- carl6 %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

carl6_health_agg <- carl6_health %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))


### Table of net losses and weighted health by geno
carl6_loss_health_table <- carl6_losses %>%
  inner_join(carl6_health_agg, by = "geno") %>%
  arrange(desc(avg_health)) 

carl6_loss_health_table_pretty <- carl6_loss_health_table
carl6_loss_health_table_pretty$avg_health <- paste0(round(carl6_loss_health_table_pretty$avg_health, 2), "%")
carl6_loss_health_table_pretty$mortality_rate <- paste0(round(carl6_loss_health_table_pretty$mortality_rate, 2), "%")
carl6_loss_health_table_pretty %>% rename("Species" = species, 
                       "Geno" = geno,
                        "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived,
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
pander()
```


**Carl's Hill 6-Month Survey: Average Tissue Health Variance**
```{r carls hill 6 month boxplot of tissue health, echo=FALSE}
### boxplot of tissue health by geno
ggplot(carl6_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       caption = "Survey Date: 2022-07-04")
```

To assess the change in tissue health, I have included the average tissue health for each genotype during the three- and six-month surveys.

**Carl's Hill: Change in Average Tissue Health**
```{r carls hill comparing surveys, echo=FALSE}
carl_spread <- carl3_loss_health_table %>%
  left_join(carl6_loss_health_table, 
            by = c("species", "geno"), suffix = c("3", "6")) %>%
  mutate(perc_change = avg_health6 - avg_health3) %>%
  arrange(desc(perc_change))

carl_long <- carl_spread %>% 
  select(species, geno, avg_health3, avg_health6, perc_change) %>%
  pivot_longer("avg_health3":"avg_health6", 
               names_to = "survey_time",
               values_to = "values")

ggplot(carl_long, aes(x = factor(geno), y = values)) +
  geom_point(aes(color = survey_time)) +
  geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
  scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) +
  scale_color_manual(labels = c("April 2022", "July 2022"), 
                     values = c("dodgerblue1", "magenta3")) +
  labs(x = "Apal Genotypes",
       y = "Percent of Healthy Tissue",
       color = "Survey") +
  theme_light()
```



## Species: Acer

The Acer species appears to be more successful than the Apal.  Over 700 more corals were outplanted at the Yellowman A location than at Carl's Hill with 11 fewer fatalities.  Additional factors are likely to contribute to these statistics; however, it is worth noting that the two locations are quite geographically close to one another.  The Yellowman sites would be subject to much of the same conditions as Carl's Hill.

The following data has been taken from surveys conducted across the Yellowman locations.  Within the location, there are A, B, and C sub-locations.

### Yellowman A 3-Month Survey

While mortality rates are consistently low for the species, there is a distinct range in the average tissue health.  Genos #14, #21, and #22 notably less successful than #17-#20.  

```{r, yellowman A data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
yellowman3A <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor"))

yellowman6A <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor"))
```

```{r yellowman3A  mortality, echo=FALSE, message=FALSE}
yellowman_losses3A <- yellowman3A %>%
  group_by(species, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present),
            mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
  arrange(desc(mortality_rate))
```

*Ranking Genotypes by Average Tissue Health*
```{r, yellowman3A calculating 3A weighted coral health by geno, echo=FALSE }
yellowman_health3A <- yellowman3A %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

yellowman_health_agg3A <- yellowman_health3A %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))

yellowman_loss_health_table3A <- yellowman_losses3A %>%
  inner_join(yellowman_health_agg3A, by = "geno") %>%
  arrange(desc(avg_health)) 

yellowman_loss_health_table3A_pretty <- yellowman_loss_health_table3A
yellowman_loss_health_table3A_pretty$avg_health <- paste0(round(yellowman_loss_health_table3A_pretty$avg_health, 2), "%")
yellowman_loss_health_table3A_pretty %>% rename("Species" = species, 
                       "Geno" = geno,
                        "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived,
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
  pander()
```

The plot below identifies the range of tissue health by genotype.  Few outliers help to confirm the average health statistics are representative of each geno's viability.

**Yellowman-A 3-Month Survey: Average Tissue Health Variance**
```{r, yellowman3A boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowman_health3A, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2021-06-23")
```

### Yellowman A 3-Month Survey

Copy about Yellowman A six-month survey...

```{r yellowman6A  mortality, echo=FALSE, message=FALSE}
yellowman_losses6A <- yellowman6A %>%
  group_by(species, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present),
            mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
  arrange(desc(mortality_rate))

```

**Ranking Genotypes by Average Tissue Health**
```{r yellowman6A calculating 6A weighted coral health by geno, echo=FALSE }
yellowman_health6A <- yellowman6A %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

yellowman_health_agg6A <- yellowman_health6A %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))

yellowman_loss_health_table6A <- yellowman_losses6A %>%
  inner_join(yellowman_health_agg6A, by = "geno") %>%
  arrange(desc(avg_health)) 

yellowman_loss_health_table6A_pretty <- yellowman_loss_health_table6A
yellowman_loss_health_table6A_pretty$mortality_rate <- paste0(round(yellowman_loss_health_table6A_pretty$mortality_rate, 2), "%")
yellowman_loss_health_table6A_pretty$avg_health <- paste0(round(yellowman_loss_health_table6A_pretty$avg_health, 2), "%")
yellowman_loss_health_table6A_pretty %>% rename("Species" = species, 
                       "Geno" = geno,
                        "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived,
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
  pander()
```

**Yellowman-A 6-Month Survey: Average Tissue Health Variance**
```{r yellowman6A boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowman_health6A, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2021-10-12")
```


The visual below indicates a more pronounced decline in tissue health than from the Carl's Hill surveys.  Furthermore, the percent decline for each genotype has a **71.7% correlation** with the initial average health rating.  Said differently, the data suggests that the negative change in tissue health has a moderate linear relationship with the initial tissue health average.  

**Yellowman A: Change in Average Tissue Health**
```{r yellowman A comparing surveys, echo=FALSE}
yellowmanA_spread <- yellowman_loss_health_table3A %>%
  left_join(yellowman_loss_health_table6A, 
            by = c("species", "geno"), suffix = c("3", "6")) %>%
  mutate(perc_change = avg_health6 - avg_health3) %>%
  arrange(desc(perc_change))

yellowmanA_long <- yellowmanA_spread %>% 
  select(species, geno, avg_health3, avg_health6, perc_change) %>%
  pivot_longer("avg_health3":"avg_health6", 
               names_to = "survey_time",
               values_to = "values")

ggplot(yellowmanA_long, aes(x = factor(geno), y = values)) +
  geom_point(aes(color = survey_time)) +
  geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
  scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) +
  scale_color_manual(labels = c("June 2021", "October 2021"), 
                     values = c("dodgerblue1", "magenta3")) +
  labs(x = "Acer Genotypes",
       y = "Percent of Healthy Tissue",
       color = "Survey") +
  theme_light()
```


### Yellowman B Location

Yellowman B Copy

```{r yellowman B, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
yellowman3B <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 4, 
                    range = 'A2:Y83',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))
```


## Ecological Footprint

Provide change in ecological footprint from outplant plot (page 25-26).

## Actionable Opportunities
There are a variety of stressors that are detrimental to the success of coral growth.  The majority of these, especially disease and predation, are out of the control of restoration efforts.  Bottom Contact, however, a stressor caused from coral agitation against the seafloor, typically occurs when corals break free from their placements.  While this is likely an unavoidable event during storms or wind-reversals, there is an opportunity to reduce the amount of overall bottom contact events through improved adhesives.  New adhesive technologies are expected to be introduced in 2023.  Comparing the percentage of Bottom Contact observations between existing site and future sites may prove to be a useful indicator of the technology's efficacy and value.

**Carl's Hill 3-Month Survey**
```{r, carl 3 bottom stressor proportion, echo=FALSE}
c3bottom_perc <- carl3 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(carl3$bottom_contact, na.rm = TRUE) / 
                sum(carl3$n_stressors, na.rm = TRUE) * 100))

c3bottom_perc$Percent_of_Total <-paste0(round(c3bottom_perc$Percent_of_Total, 2), "%")
c3bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Precent of Total" = Percent_of_Total) %>%
  pander()
```

**Carl's Hill 6-Month Survey**
```{r carl 6 bottom stressor proportion, echo=FALSE}
c6bottom_perc <- carl6 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(carl6$bottom_contact, na.rm = TRUE) / 
                sum(carl6$n_stressors, na.rm = TRUE) * 100))

c6bottom_perc$Percent_of_Total <-paste0(round(c6bottom_perc$Percent_of_Total, 2), "%")
c6bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Precent of Total" = Percent_of_Total) %>%
  pander()
```
**Yellowman B 3-Month Survey**
```{r opportunities yellowmanB3 bottom contact, echo=FALSE}
yb3bottom_perc <- yellowman3B %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(yellowman3B$bottom_contact, na.rm = TRUE) / 
                sum(yellowman3B$n_stressors, na.rm = TRUE) * 100))

yb3bottom_perc$Percent_of_Total <-paste0(round(yb3bottom_perc$Percent_of_Total, 2), "%")
yb3bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Precent of Total" = Percent_of_Total) %>%
  pander()
```

