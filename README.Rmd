---
title: "Analysis of Coral Restoration Efforts"
subtitle: "A Collaboration with Bonaire Reef Renewal Foundation"
author: "Tadge McWilliams"
date: "May 19th, 2023"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r, load libraries, include=FALSE, echo=FALSE}
library(readxl)
library(tidyverse)
library(pander)
library(flextable)
library(rempsyc)
```


![](/Users/tadgemcwilliams/Documents/Data Science/Reef Renewal Bonaire/RRFB/Carl's Hill_IG.jpg)



## Summary
The goal of this project is to assist [Bonaire Reef Renewal Foundation](https://www.reefrenewalbonaire.org) (BRRF) in developing a successful, data driven program to efficiently introduce new, "reef-ready" corals into Bonaire's reef systems.  By analyzing survey data from multiple coral reef outplanting locations, I attempt to provide insights into the viability of two coral species, their genotypes, and the overall changes to the ecological footprints of the restored reef locations.  Special interest was given to the performance of coral growth on the geno-level.  The successful propagation and growth of multiple genotypes is central to the diversity of the species.  Additionally, if certain genotypes prove to be more resistant to temperature fluctuation than others, they may become vitual to the long-term success of the species as we face the realities of climate change.  Through mortality and average tissue health calculations, I was able to identify which genotypes are performing better than others and begin to track the changes in tissue health over time.  While more analysis is needed, I hope this project will lead to the development of future models from which BRRF and others can further their work.

## Methodology

This analysis is intended to adhere to the guidance proposed by the National Oceanic & Atmospheric Association (NOAA) in its September 2020 technical memorandum *Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local Ecosystem Scales.* All data was provided by BRRF.  The ecological footprint data was collected from photomosaics and traditional underwater surveying methods.  The Carl's Hill and Yellowman data was provided after detailed three- and six-month surveys of the outplanted sites.  
Mortality rates are a standard calculation of (corals present - corals outplanted) / corals outplanted.  Average tissue health is calculated as a weighted average of five tissue-health categories.  Corals are partitioned into tissue health groups of 1-25%, 26-50%, 51-75%, 76-99%, and 100%.  The central point of each category (12.5%, 40%, 65%, 87%, and 100%) is used to calculate the average tissue health.  This calculation does not include dead observations, or those with 0% tissue health.[^1]
All calculations and visualizations are performed using R.  R packages for this project include readxl, dplyr, ggplot2, flextable, and rempsyc.  The report is formatted in Markdown, and all versions have been pushed to a github repository.

[^1]: Goergen, E.A., Schopmeyer, S., Moulding, A.L., Moura, A., Kramer, P., and Viehman, T.S. 2020. Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local to Ecosystem Scales. NOAA Technical Memorandum NOS NCCOS 279. Silver Spring, MD. 158 pp. https://doi.org/10.25923/xndz-h538


```{r, loading data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")

### Carl 3-Month Survey
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))

### Carl 6-Month Survey
carl6 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 3, 
                    range = 'A2:Z51',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cyanob", "sedimentation", "unknown", "n_stressors"))

### Yellowman A 3-Month Survey
yellowmanA3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor"))

### Yellowman A 6-Month Survey
yellowmanA6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor"))

### Yellowman B 3-Month Survey
yellowmanB3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 4, 
                    range = 'A2:Y83',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))

### Yellowman B 6-Month Survey
yellowmanB6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 5, 
                    range = 'A2:Z82',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", "bottom_contact", 
                                  "fireworm", "snail", "cyanob", "competition", "unknown", "n_stressors"))

### Yellowman C 3-Month Survey
yellowmanC3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 6, 
                    range = 'A2:Z34',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", "bottom_contact", 
                                  "fireworm", "snail", "cyanob", "competition", "unknown", "n_stressors"))

###Monitoring Summary
ltsummary <- read_excel("Monitoring Summary.xlsx", 
                    sheet = 4, 
                    range = 'A3:N24',
                    col_names = c("site_name", "site_code", "species", "op_date", "subsite", 
                                  "survey_date","duration", "time_code", "eco_footprint",
                                  "tot_coral_area", "restored_area", "perc_coral_cover", 
                                  "coral_density", "restored_size_cm"))
```


## Ecological Footprint

```{r, foramtting Ltsummary, echo=FALSE}
### Removing NAs  
ltsummary <- ltsummary %>% drop_na(eco_footprint)
```
The following visuals highlight the changes in ecological footprints and total coral coverage from year to year.  Data from BRRF's long-term surveys was used for this section.  As new outplanting sites are created each year, not all sites have been surveyed equally.  

```{r ecological footprint, echo=FALSE}

### Possible Apal options: Knife I, Oilslick (2x), South Bay II (2x)
### Possible Acer options: Mi Dushi I, Punt Vierkant
ltsummary %>% 
  ggplot(aes(x=survey_date, y=eco_footprint, color = site_name, shape = species)) +
    geom_point(size = 3) +
    geom_line() + 
    labs(x = 'Time', 
         y = 'Eco-Footprint (m)',
         color = 'Site',
         shape = 'Species',
         title = 'Change in Ecological Footprints Over Time') + 
  theme(plot.title = element_text(face = "italic"))

```


```{r longterm total coral area, echo=FALSE}
ltsummary %>% 
  filter(tot_coral_area < 100) %>%
  ggplot(aes(x=survey_date, y=tot_coral_area, color = site_name, shape = species)) +
    geom_point(size = 3) +
    geom_line() + 
    labs(x = 'Time', 
         y = 'Total Coral Area (m)',
         color = 'Site',
         shape = 'Species',
         title = 'Change in Total Coral Area Over Time') +
    theme(plot.title = element_text(face = "italic"))
```


In the visual below, I have highlighted the change in Eco Footprint, Total Coral Area, and Restored Area over time by site.  As additional surveys are added, it may be possible to tune a model to predict future trends.  Please note that the Total Coral Area and Restored Area often share the same values, or can be quite similar, during the early years of growth.

```{r, eco growth by metric, echo=FALSE, message=FALSE}
ltsummary_long <- ltsummary %>% 
  pivot_longer("eco_footprint":"restored_area", 
               names_to = "metric",
               values_to = "values") 

ltsummary_long %>%
  ggplot(aes(x=survey_date, y=values, color=metric, shape=species)) +
    geom_point(size = 3) +
    geom_line() + 
    facet_wrap(vars(site_name)) +
    scale_color_discrete(labels = c("Eco-Footprint", "Restored Area", "Total Coral Area")) +
    labs(x = 'Time', 
         y = 'Growth (m)',
         color = 'Metric',
         shape = 'Species',
         title = 'Long-Term Growth by Site') +
    guides(color=guide_legend(override.aes=list(shape=15))) + 
    theme(plot.title = element_text(face = "italic"))
```



## Species: Apal

### Carl's Hill 3-Month Survey

The summary statistics below were generated from a survey of coral health between April 11th, 2021 to May 4th, 2021, approximately three months after the initial outplanting of corals at Carl's Hill.  Note that Genos #16 and #7 appear to have negative mortality rates.  These statistics were caused because more observations were recorded during the three-month survey than were originally outplanted.  It is unknown whether this was caused by a division of corals or a survey error.

Apart from the mortality rate, an important universal metric included in the survey is to record the percentage of healthy coral tissue for each observation.  Predation, disease, and other environmental factors are detrimental to coral growth.  Below, I have created a weighted average of tissue health by genotype.  


```{r, carls hill 3 month weighted coral health by geno, echo=FALSE, message=FALSE}
carl_health <- carl3 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
carl3_agg <- carl_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
carl3_agg_pretty <- carl3_agg
carl3_agg_pretty$mortality_rate <- paste0(round(carl3_agg_pretty$mortality_rate, 2), "%")
carl3_agg_pretty$avg_health <- paste0(round(carl3_agg_pretty$avg_health, 2), "%")
carl3_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Carl's Hill 3-Month Survey: Ranking Genotypes by Average Tissue Health")
```



Outliers can easily skew the averages of an aggregate summary.  The plot below identifies the range of tissue health by genotype.  While the average tissue health of genos #1, #9, and #21 is slightly depressed from a few poorly performing outliers, it appears that genos #14, #16, #18, #19, and #22 are generally less resilient than the others.


```{r, carls hill boxplot of tissue health by geno, echo=FALSE}
ggplot(carl_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       caption = "Adj. Survey Date: 2022-04-27",
       title = "Carl's Hill 3-Month Survey: Average Tissue Health Variance") + 
    theme(plot.title = element_text(face = "italic"))
```

### Carl's Hill 6-Month Survey
The following data was taken three months later in a survey conducted on July 4th, 2022.   When compared with the three-month survey, some genos have performed better than others.  Genos #2, #5, #13, #22-23 maintained a 0% mortality rate.  Genos #6-9 and #22-23 improved in average tissue health, while the remaining genos declined in health.  


```{r carls hill 6 month weighted health, echo=FALSE, message=FALSE}
carl6_health <- carl6 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
carl6_agg <- carl6_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
carl6_agg_pretty <- carl6_agg
carl6_agg_pretty$mortality_rate <- paste0(round(carl6_agg_pretty$mortality_rate, 2), "%")
carl6_agg_pretty$avg_health <- paste0(round(carl6_agg_pretty$avg_health, 2), "%")
carl6_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Carl's Hill 6-Month Survey: Ranking Genotypes by Average Tissue Health")
```

The changes in variance between the three- and six-month surveys often correspond with the addition of new stressors to some of the observations. 


```{r carls hill 6 month boxplot of tissue health, echo=FALSE}

ggplot(carl6_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       caption = "Survey Date: 2022-07-04",
       title = "Carl's Hill 6-Month Survey: Average Tissue Health Variance") + 
    theme(plot.title = element_text(face = "italic"))
```

To better visualize the change in tissue health, I have summarized the average tissue health for each genotype during the three- and six-month surveys. Comparing changes and combining the data from other Apal sites may help create a more diverse sample and reduce site bias.


```{r carls hill comparing surveys, echo=FALSE}

carl_spread <- carl3_agg %>%
  left_join(carl6_agg, 
            by = c("species", "geno"), suffix = c("3", "6")) %>%
  mutate(perc_change = avg_health6 - avg_health3) %>%
  arrange(desc(perc_change))

carl_long <- carl_spread %>% 
  select(species, geno, avg_health3, avg_health6, perc_change) %>%
  pivot_longer("avg_health3":"avg_health6", 
               names_to = "survey_time",
               values_to = "values")

ggplot(carl_long, aes(x = factor(geno), y = values)) +
  geom_point(aes(color = survey_time)) +
  geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
  scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) +
  scale_color_manual(labels = c("April 2022", "July 2022"), 
                     values = c("dodgerblue1", "magenta3")) +
  labs(x = "Apal Genotypes",
       y = "Percent of Healthy Tissue",
       color = "Survey",
       title = "Carl's Hill: Change in Average Tissue Health") +
  theme_light() + 
  theme(plot.title = element_text(face = "italic"))
```



## Species: Acer

The following data was taken from surveys conducted across the Yellowman sites.  Within the Yellowman site, there are A, B, and C sub-sites.

The Acer species appears to be more successful than the Apal.  Over 700 more corals were outplanted at the Yellowman A location than at Carl's Hill with 11 fewer fatalities.  Additional factors are likely to contribute to these statistics; however, it is worth noting that the two locations are quite geographically close to one another.  The Yellowman sites would be subject to much of the same conditions as Carl's Hill.


### Yellowman A 3-Month Survey

While mortality rates are consistently low for the species, there is a broad range in average tissue health.  Genos #14, #21, and #22 are notably less successful than #17-#20.  


```{r, yellowman3A calculating A3 weighted coral health by geno, echo=FALSE, message=FALSE}
yellowmanA3_health <- yellowmanA3 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
yellowmanA3_agg <- yellowmanA3_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
yellowmanA3_agg_pretty <- yellowmanA3_agg
yellowmanA3_agg_pretty$mortality_rate <- paste0(round(yellowmanA3_agg_pretty$mortality_rate, 2), "%")
yellowmanA3_agg_pretty$avg_health <- paste0(round(yellowmanA3_agg_pretty$avg_health, 2), "%")
yellowmanA3_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Yellowman A 3-Month Survey: Ranking Genotypes by Average Tissue Health")
```


The plot below identifies the range of tissue health by genotype.  Few outliers help to confirm the average health statistics are representative of each geno's viability.


```{r, yellowmanA3 boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowmanA3_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2021-06-23",
       title = "Yellowman A 3-Month Survey: Average Tissue Health Variance") + 
    theme(plot.title = element_text(face = "italic"))
```


### Yellowman A 6-Month Survey


After six months, genos #17, #21, and #22 still have a 0% mortality rate.


```{r yellowmanA6 calculating 6A weighted coral health by geno, echo=FALSE, message=FALSE}
yellowmanA6_health <- yellowmanA6 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
yellowmanA6_agg <- yellowmanA6_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
yellowmanA6_agg_pretty <- yellowmanA6_agg
yellowmanA6_agg_pretty$mortality_rate <- paste0(round(yellowmanA6_agg_pretty$mortality_rate, 2), "%")
yellowmanA6_agg_pretty$avg_health <- paste0(round(yellowmanA6_agg_pretty$avg_health, 2), "%")
yellowmanA6_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Yellowman A 6-Month Survey: Ranking Genotypes by Average Tissue Health")
```


The variance of tissue health below remains relatively stable.  Most corals have decreased in average health, but the interquartile range of observations is fairly close.


```{r yellowman6A boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowmanA6_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2021-10-12",
       title = "Yellowman A 6-Month Survey: Average Tissue Health Variance") +
    theme(plot.title = element_text(face = "italic"))
```


The visual below indicates a more pronounced decline in tissue health than from the Carl's Hill surveys. The percent decline of each geno has a *71.7% correlation* with the initial average health rating of that geno.  This correlation could be investigated further to see if a more diverse sample of the population yields a more robust model.    


```{r yellowman A comparing surveys, echo=FALSE}
yellowmanA_spread <- yellowmanA3_agg %>%
  left_join(yellowmanA6_agg, 
            by = c("species", "geno"), suffix = c("3", "6")) %>%
  mutate(perc_change = avg_health6 - avg_health3) %>%
  arrange(desc(perc_change))

yellowmanA_long <- yellowmanA_spread %>% 
  select(species, geno, avg_health3, avg_health6, perc_change) %>%
  pivot_longer("avg_health3":"avg_health6", 
               names_to = "survey_time",
               values_to = "values")

ggplot(yellowmanA_long, aes(x = factor(geno), y = values)) +
  geom_point(aes(color = survey_time)) +
  geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
  scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) +
  scale_color_manual(labels = c("June 2021", "October 2021"), 
                     values = c("dodgerblue1", "magenta3")) +
  labs(x = "Acer Genotypes",
       y = "Percent of Healthy Tissue",
       color = "Survey",
       title = "Yellowman A: Change in Average Tissue Health") +
  theme_light() + 
  theme(plot.title = element_text(face = "italic"))
```


### Yellowman B 3-Month Survey


At Yellowman B, BRRF outplanted different genotypes from those at Yellowman A.  Only geno #1 is shared between Yellowman A and Yellowman B.


```{r yellowmanB3 calculating B3 weighted coral health by geno, echo=FALSE, message=FALSE}
yellowmanB3_health <- yellowmanB3 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
yellowmanB3_agg <- yellowmanB3_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
yellowmanB3_agg_pretty <- yellowmanB3_agg
yellowmanB3_agg_pretty$mortality_rate <- paste0(round(yellowmanB3_agg_pretty$mortality_rate, 2), "%")
yellowmanB3_agg_pretty$avg_health <- paste0(round(yellowmanB3_agg_pretty$avg_health, 2), "%")
yellowmanB3_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Yellowman B 3-Month Survey: Ranking Genotypes by Average Tissue Health")
```


With the exception of geno #9, most genotypes have relatively high average tissue health. 


```{r yellowmanB3 boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowmanB3_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2022-03-24",
       title = "Yellowman B 3-Month Survey: Average Tissue Health Variance") + 
    theme(plot.title = element_text(face = "italic"))
```


### Yellowman B 6-Month Survey


The six-month survey of Yellowman B shows quite a low mortality rate.


```{r yellowmanB6 calculating B6 weighted coral health by geno, echo=FALSE, message=FALSE}
yellowmanB6_health <- yellowmanB6 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
yellowmanB6_agg <- yellowmanB6_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
yellowmanB6_agg_pretty <- yellowmanB6_agg
yellowmanB6_agg_pretty$mortality_rate <- paste0(round(yellowmanB6_agg_pretty$mortality_rate, 2), "%")
yellowmanB6_agg_pretty$avg_health <- paste0(round(yellowmanB6_agg_pretty$avg_health, 2), "%")
yellowmanB6_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Yellowman B 6-Month Survey: Ranking Genotypes by Average Tissue Health")
```


There are many tissue health outliers in the six-month survey. Disease, ciliate, and fireworm stressors were common.  However, geno #9 had the lowest average tissue health of any Yellowman B geno, but only one fireworm stressor was recorded out of the 50 corals observed.  This indicates its poorer performance is not due to the observed stressors.


```{r yellowmanB6 boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowmanB6_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2022-06-30",
       title = "Yellowman B 6-Month Survey: Average Tissue Health Variance") +
    theme(plot.title = element_text(face = "italic"))
```


The average change in tissue health between surveys is lower at Yellowman B than at other sites.  This data furthers the possibility that the genotypes at Yellowman B are more resiliant than those at Yellowman A.


```{r yellowman B comparing surveys, echo=FALSE}
yellowmanB_spread <- yellowmanB3_agg %>%
  left_join(yellowmanB6_agg, 
            by = c("species", "geno"), suffix = c("3", "6")) %>%
  mutate(perc_change = avg_health6 - avg_health3) %>%
  arrange(desc(perc_change))

yellowmanB_long <- yellowmanB_spread %>% 
  select(species, geno, avg_health3, avg_health6, perc_change) %>%
  pivot_longer("avg_health3":"avg_health6", 
               names_to = "survey_time",
               values_to = "values")

ggplot(yellowmanB_long, aes(x = factor(geno), y = values)) +
  geom_point(aes(color = survey_time)) +
  geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
  scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) +
  scale_color_manual(labels = c("March 2022", "June 2022"), 
                     values = c("dodgerblue1", "magenta3")) +
  labs(x = "Acer Genotypes",
       y = "Percent of Healthy Tissue",
       color = "Survey",
       title = "Yellowman B: Change in Average Tissue Health") +
  theme_light() +
  theme(plot.title = element_text(face = "italic"))
```


### Yellowman C 3-Month Survey


The Yellowman C site shares many of the same genos as at Yellowman A.  The mortality rate, however, is much greater at Yellowman C.


```{r, yellowman C 3-Month weighted coral health by geno, echo=FALSE, message=FALSE}
yellowmanC3_health <- yellowmanC3 %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

### Aggregate Table
yellowmanC3_agg <- yellowmanC3_health %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100,
              avg_health = mean(weighted_health)) %>%
    arrange(desc(avg_health))

### Table Formatting
yellowmanC3_agg_pretty <- yellowmanC3_agg
yellowmanC3_agg_pretty$mortality_rate <- paste0(round(yellowmanC3_agg_pretty$mortality_rate, 2), "%")
yellowmanC3_agg_pretty$avg_health <- paste0(round(yellowmanC3_agg_pretty$avg_health, 2), "%")
yellowmanC3_agg_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
nice_table(title = "Yellowman C 3-Month Survey: Ranking Genotypes by Average Tissue Health")
```


Stressors were present in all but three of the observations.  It is likely stressors are an important factor in the lower average tissue health at the site.  A six-month survey is not yet available for Yellowman C.  In the future, it will be interesting to compare the three- to six-month changes at Yellowman C with those at Yellowman A.


```{r yellowmanC3 boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowmanC3_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       caption =  "Adj. Survey Date: 2022-11-12",
       title = "Yellowman C 3-Month Survey: Average Tissue Health Variance") +
  theme(plot.title = element_text(face = "italic"))
```


### Comparing Yellowman Sites

In the visual below, I have extracted the genotypes present at both Yellowman A and Yellowman C, as of their three-month surveys.  The data suggests that the corals at Yellowman A are out performing those at Yellowman C.  One noteworthy difference is that the Yellowman A survey was conducted in June 2021 while the Yellowman C survey was conducted in November 2022.  Seasonal water temperatures would have differed during the preceding three months, creating a potentially unequal environment for comparison.  It is unknown if differences in propagation or outplanting techniques existed between the two sites. 


```{r Comparing YellowmanA 3 with Yellowman C 3, echo=FALSE}
yellowmanA3C3_health <- yellowmanA3_health %>%
                            mutate(location = "yellowmanA") %>%
                            bind_rows(yellowmanC3_health)
yellowmanA3C3_health <- yellowmanA3C3_health %>% replace_na(list(location = 'yellowmanC'))

yellowmanA3C3_health %>% 
  filter(geno %in% yellowmanA3_health$geno & geno %in% yellowmanC3_health$geno) %>%
  ggplot(aes(x = factor(geno), y = weighted_health, color = location)) + 
    geom_point() +
    scale_color_discrete(labels = c("Yellowman A", "Yellowman C")) +
    scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
    labs(x = "Acer Genotype", 
         y = "Percent of Healthy Tissue",
        color = "Location",
        title = "Comparing Average Tissue Health Between Acer Sites From 3-Month Surveys") +
    theme(plot.title = element_text(face = "italic"))
```


## Actionable Opportunities

There are a variety of stressors that are detrimental to the success of coral growth.  The majority of these are out of the control of restoration efforts.  Bottom Contact, however, a stressor caused from coral agitation against the seafloor, typically occurs when corals break free from their placements.  While this is unavoidable during storms and wind-reversals, there is an opportunity to reduce the amount of overall bottom contact events through improved adhesives.  New adhesive technologies are expected to be introduced in 2023.  Comparing the percentage of Bottom Contact observations between existing sites and future sites may prove to be a useful indicator of the technology's efficacy and value.


```{r, carl 3 bottom stressor proportion, echo=FALSE}
c3bottom_perc <- carl3 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(carl3$bottom_contact, na.rm = TRUE) / 
                N_Outplanted * 100))

c3bottom_perc$Percent_of_Total <-paste0(round(c3bottom_perc$Percent_of_Total, 2), "%")
c3bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Percent of Surveyed" = Percent_of_Total) %>%
  nice_table(title = "Carl's Hill 3-Month Survey")
```


```{r carl 6 bottom stressor proportion, echo=FALSE}
c6bottom_perc <- carl6 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(carl6$bottom_contact, na.rm = TRUE) / 
                N_Outplanted * 100))

c6bottom_perc$Percent_of_Total <-paste0(round(c6bottom_perc$Percent_of_Total, 2), "%")
c6bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Percent of Surveyed" = Percent_of_Total) %>%
  nice_table(title = "Carl's Hill 6-Month Survey")
```


```{r opportunities yellowmanB3 bottom contact, echo=FALSE}
yb3bottom_perc <- yellowmanB3 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(yellowmanB3$bottom_contact, na.rm = TRUE) / 
                N_Outplanted * 100))

yb3bottom_perc$Percent_of_Total <-paste0(round(yb3bottom_perc$Percent_of_Total, 2), "%")
yb3bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Percent of Surveyed" = Percent_of_Total) %>%
  nice_table(title = "Yellowman B 3-Month Survey")
```


```{r opportunities yellowmanB6 bottom contact, echo=FALSE}
yb6bottom_perc <- yellowmanB6 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(yellowmanB6$bottom_contact, na.rm = TRUE) / 
                N_Outplanted * 100))

yb6bottom_perc$Percent_of_Total <-paste0(round(yb6bottom_perc$Percent_of_Total, 2), "%")
yb6bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Percent of Surveyed" = Percent_of_Total) %>%
  nice_table(title = "Yellowman B 6-Month Survey")
```


```{r pportunities yellowmanC3 bottom contact, echo=FALSE}
yc3bottom_perc <- yellowmanC3 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(yellowmanC3$bottom_contact, na.rm = TRUE) / 
                N_Outplanted * 100))

yc3bottom_perc$Percent_of_Total <-paste0(round(yc3bottom_perc$Percent_of_Total, 2), "%")
yc3bottom_perc %>% rename("# Surveyed" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Percent of Surveyed" = Percent_of_Total) %>%
  nice_table(title = "Yellowman C 3-Month Survey")
```


