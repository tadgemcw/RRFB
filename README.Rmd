---
title: "Analysis of Coral Restoration Efforts"
subtitle: "In Collaboration with Bonaire Reef Renewal Foundation"
author: "Tadge McWilliams"
date: "April 26th, 2023"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r, load libraries, include=FALSE, echo=FALSE}
library(readxl)
library(tidyverse)
library(pander)
```

## Introduction
The goal of this project is to assist [Bonaire Reef Renewal Foundation](https://www.reefrenewalbonaire.org) in developing a successful, data driven program through which to efficiently introduce new, "reef-ready" corals into Bonaire's reef systems.  By analyzing survey data from multiple coral reef outplanting locations, I attempt to provide insights into the viability of two coral species, their genotypes, and the overall changes in the ecological footprints of the outplanting locations.  The following analysis is intended to adhear to the guidence proposed by NOAA in its September 2020 technical memorandum *Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local Ecosystem Scales.*

## Species: Apal
### Carl's Hill 3-Month Survey
The summary statistics below were generated from a survey of coral health between April 11th, 2021 and May 4th, 2021, approximately three months after the initial outplanting of corals at Carl's Hill.  
Genos #16 and #7 appear to have negative mortality rates.  These statistics were caused because more observations were recorded during the 3-month survey than were originally outplanted.  It is unknown if this was caused by a division of the previously outplanted corals or a survey error.

```{r, carls hill data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))
```

**Carl's Hill 3-Month Survey: Ranking Genotypes by Mortality Rate**
```{r, carls hill calculating coral losses by geno, echo=FALSE, message=FALSE}
carl_losses <- carl3 %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present),
              mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
    arrange(desc(mortality_rate))

carl_losses$mortality_rate <- paste0(round(carl_losses$mortality_rate, 2), "%")
carl_losses %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate) %>%
  pander()
```

Another universal metric included in the survey is to record the percentage of healthy coral tissue for each observation.  Predation, disease, and other environmental factors are detrimental to coral growth.  Below, I have created a weighted average of tissue health by genotype.  I should note that the weighted average of tissue health does not include dead observations. [^1]

[^1]: Goergen, E.A., Schopmeyer, S., Moulding, A.L., Moura, A., Kramer, P., and Viehman, T.S. 2020. Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local to Ecosystem Scales. NOAA Technical Memorandum NOS NCCOS 279. Silver Spring, MD. 158 pp. https://doi.org/10.25923/xndz-h538

**Carl's Hill 3-Month Survey: Ranking Genotypes by Average Tissue Health**
```{r, carls hill calculating weighted coral health by geno, echo=FALSE}
carl_health <- carl3 %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

carl_health_agg <- carl_health %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))


### Table of net losses and weighted health by geno
carl3_loss_health_table <- carl_losses %>%
  inner_join(carl_health_agg, by = "geno") %>%
  select(species, geno, avg_health, mortality_rate) %>%
  arrange(desc(avg_health)) 

carl3_loss_health_table_pretty <- carl3_loss_health_table
carl3_loss_health_table_pretty$avg_health <- paste0(round(carl3_loss_health_table_pretty$avg_health, 2), "%")


carl3_loss_health_table_pretty %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
pander()
```


Outliers can easily skew the averages of an aggregate summary.  The plot below identifies the range of tissue health by genotype.  While the average tissue health of genos #1, #9, and #21 is slightly depressed from a few poorly performing outliers, it appears that genos #14, #16, #18, #19, and #22 are generally less resilient than the others.

**Carl's Hill 3-Month Survey: Average Tissue Health Variance**
```{r, carls hill boxplot of tissue health by geno, echo=FALSE}
ggplot(carl_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       caption = "Adj. Survey Date: 2022-04-27")
```

### Carl's Hill 6-Month Survey
The following data was taken three months later in a survey conducted on July 4th, 2022. 

```{r, carls hill 6 month survey data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
carl6 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 3, 
                    range = 'A2:Z51',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cyanob", "sedimentation", "unknown", "n_stressors"))
```



**Carlâ€™s Hill 6-Month Survey: Ranking Genotypes by Mortality Rate**
```{r carls hill 6 month mortality rate, echo=FALSE, message=FALSE}
carl6_losses <- carl6 %>%
  group_by(species, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present),
            mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
  arrange(desc(mortality_rate))

carl6_losses_pretty <- carl6_losses
carl6_losses_pretty$mortality_rate <- paste0(round(carl6_losses_pretty$mortality_rate, 2), "%")
carl6_losses_pretty %>% pander()
```

**Carl's Hill 6-Month Survey: Ranking Genotypes by Average Tissue Health**
```{r carls hill 6 month weighted health, echo=FALSE}
### Calculating weighted coral health by geno
carl6_health <- carl6 %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)


carl6_health_agg <- carl6_health %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))


### Table of net losses and weighted health by geno
carl6_loss_health_table <- carl6_losses %>%
  inner_join(carl6_health_agg, by = "geno") %>%
  select(species, geno, avg_health, mortality_rate) %>%
  arrange(desc(avg_health)) 

carl6_loss_health_table_pretty <- carl6_loss_health_table
carl6_loss_health_table_pretty$avg_health <- paste0(round(carl6_loss_health_table_pretty$avg_health, 2), "%")
carl6_loss_health_table_pretty$mortality_rate <- paste0(round(carl6_loss_health_table_pretty$mortality_rate, 2), "%")
pander(carl6_loss_health_table_pretty)
```


**Carl's Hill 6-Month Survey: Average Tissue Health Variance**
```{r carls hill 6 month boxplot of tissue health, echo=FALSE}
### boxplot of tissue health by geno
ggplot(carl6_health, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue",
       caption = "Survey Date: 2022-07-04")
```
The visualization below tracks the change in average tissue health for each geno between the three- and six-month surveys.

**Carl's Hill: Change in Average Tissue Health**
```{r carls hill comparing surveys, echo=FALSE}
carl_spread <- carl3_loss_health_table %>%
  left_join(carl6_loss_health_table, 
            by = c("species", "geno"), suffix = c("3", "6")) %>%
  mutate(perc_change = avg_health6 - avg_health3) %>%
  arrange(desc(perc_change))

carl_long <- carl_spread %>% 
  select(species, geno, avg_health3, avg_health6, perc_change) %>%
  pivot_longer("avg_health3":"avg_health6", 
               names_to = "survey_time",
               values_to = "values")

ggplot(carl_long, aes(x = factor(geno), y = values)) +
  geom_point(aes(color = survey_time)) +
  geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
  scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) +
  scale_color_manual(labels = c("April 2022", "July 2022"), 
                     values = c("dodgerblue1", "magenta3")) +
  labs(x = "Apal Genotypes",
       y = "Percent of Healthy Tissue",
       color = "Survey") +
  theme_light()
```



## Species: Acer
The Acer species appears to be more successful than the Apal.  Over 700 more corals were outplanted at Yellowman A than at Carl's Hill with 11 fewer fatalities.  Additional factors are likely to contribute to these statistics; however, it is worth noting that the two locations are geographically quite close to one another.  The Yellowman sites would be subject to much of the same weather conditions as Carl's Hill.

### Yellowman A Location

```{r, yellowman data, echo=FALSE}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")
yellowman3A <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor"))

yellowman6A <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor"))
```

The following data has been taken from surveys conducted across the Yellowman restoration locations.  Within the location, there are A, B, and C sub-locations.

*3-Month Survey: Ranking Genotypes by Mortality Rate*
```{r yellowman3 calculating coral losses by geno, echo=FALSE, message=FALSE}
yellowman_losses3A <- yellowman3A %>%
  group_by(species, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present),
            mortality_rate = ((num_outplanted - num_survived) / num_outplanted) * 100) %>%
  arrange(desc(mortality_rate))

yellowman_losses3A$mortality_rate <- paste0(round(yellowman_losses3A$mortality_rate, 2), "%")
yellowman_losses3A %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate) %>%
  pander()
```
While mortality rates are consistently low for the species, there is a distinct range in the average tissue health.  Genos #14, #21, and #22 notably less successful than #17-#20.  

*Ranking Genotypes by Average Tissue Health*
```{r, yellowman3A calculating 3A weighted coral health by geno, echo=FALSE }
yellowman_health3A <- yellowman3A %>%
  select(geno, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.4, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.65, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)

yellowman_health_agg3A <- yellowman_health3A %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health)) %>%
  arrange(desc(avg_health))

yellowman_loss_health_table3A <- yellowman_losses3A %>%
  inner_join(yellowman_health_agg3A, by = "geno") %>%
  select(species, geno, avg_health, mortality_rate) %>%
  arrange(desc(avg_health)) 

yellowman_loss_health_table3A$avg_health <- paste0(round(yellowman_loss_health_table3A$avg_health, 2), "%")
yellowman_loss_health_table3A %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "Avg. Health" = avg_health, 
                       "Mortality Rate" = mortality_rate) %>% 
  pander()
```

The plot below identifies the range of tissue health by genotype.  Few outliers help to confirm the average health statistics are representative of each geno's viability.

```{r, yellowman3A boxplot of tissue health by geno, echo=FALSE}
ggplot(yellowman_health3A, aes(x = factor(geno), y = weighted_health)) + 
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Acer Genotype", 
       y = "Percent of Healthy Tissue",
       title = "Yellowman A",
       subtitle = "3-Month Survey",
       caption =  "Adj. Survey Date: 2021-06-23")
```

### Yellowman B
Yellowman B Copy

## Actionable Opportunities
There are a variety of stressors that are detrimental to the success of coral growth.  The majority of these, especially desease and predation, are out of the control of the foundation's efforts.  Bottom contract--a stressor caused from agitation against the seafloor--typically occurs when corals break free from their placements.  While this is unavoidable during tropical storms or wind-reversals, there is an opportunity reduce the amount of overall bottom contract events with improved adhesives.  New adhesive technologies are expected to be introduced in 2023.  It will be interesting to compare the percentage of Bottom Contact observations after future outplantings.

*Carl's Hill 3-Month Survey*
```{r, bottom stressor proportion, echo=FALSE}
bottom_perc <- carl3 %>%
  summarize(N_Outplanted = n(),
            Total_Stressors = sum(n_stressors, na.rm = TRUE),
            Bottom_Contact = sum(bottom_contact, na.rm = TRUE),
            Percent_of_Total = (sum(carl3$bottom_contact, na.rm = TRUE) / 
                sum(carl3$n_stressors, na.rm = TRUE) * 100))

bottom_perc$Percent_of_Total <-paste0(round(bottom_perc$Percent_of_Total, 2), "%")
bottom_perc %>% rename("# Outplanted" = N_Outplanted,
                       "Total Stressors" = Total_Stressors,
                        "Bottom Contact" = Bottom_Contact,
                       "Precent of Total" = Percent_of_Total) %>%
  pander()
```