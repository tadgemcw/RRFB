---
title: "Analysis of Coral Restoration Efforts"
subtitle: "A Collaboration with Reef Renewal Bonaire"
author: "Tadge McWilliams"
date: "Updated 2023-09-30"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r global settings, setup, include=FALSE}
library(knitr) #global settings
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r, load libraries, include=FALSE}
library(readxl)
library(tidyverse)
library(pander)
library(flextable)
library(rempsyc)
library(RColorBrewer)
#display.brewer.all(colorblindFriendly = TRUE)
library(viridisLite)
library(viridis)
```

```{r, loading data}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")

###Monitoring Summary
ltsummary <- read_excel("Monitoring Summary.xlsx", 
                    sheet = 4, 
                    range = 'A3:N24',
                    col_names = c("site_name", "site_code", "species", "op_date", "subsite", 
                                  "survey_date","duration", "time_code", "eco_footprint",
                                  "tot_coral_area", "restored_area", "perc_coral_cover", 
                                  "coral_density", "restored_size_cm"))

##### Acer Data
# Mi Dushi I Survey
midushi13 <- read_excel("Mi Dushi I Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q71',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor")) %>%
            mutate(site = "Mi Dushi")

# Punt Vierkant 3-Month Survey
puntv3 <- read_excel("PV_Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'A2:Y92',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Punt Vierkant")

# Punt Vierkant 6-Month Survey
puntv6 <- read_excel("PV_Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:Y92',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Punt Vierkant")

# Yellowman A 3-Month Survey
yellowmanA3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor")) %>%
            mutate(site = "Yellowman A")

# Yellowman A 6-Month Survey
yellowmanA6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor")) %>%
            mutate(site = "Yellowman A")

# Yellowman B 3-Month Survey
yellowmanB3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 4, 
                    range = 'A2:Y83',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Yellowman B")

# Yellowman B 6-Month Survey
yellowmanB6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 5, 
                    range = 'A2:Z82',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", "bottom_contact", 
                                  "fireworm", "snail", "cyanob", "competition", "unknown", "n_stressors")) %>%
            mutate(site = "Yellowman B")

# Yellowman C 3-Month Survey
yellowmanC3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 6, 
                    range = 'A2:Z34',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", 
                                  "bottom_contact", "fireworm", "snail", "cyanob", "competition", "unknown",
                                  "n_stressors")) %>%
            mutate(site = "Yellowman C")

#### Apal Data
# Carl 3-Month Survey
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Carl's Hill")

# Carl 6-Month Survey
carl6 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 3, 
                    range = 'A2:Z51',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cyanob", "sedimentation", "unknown", "n_stressors")) %>%
            mutate(site = "Carl's Hill")

# Knife A 3-Month Survey
knifeA3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Knife A")

# Knife A 5-Month Survey
knifeA5 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife A")

# Knife A 6-Month Survey
knifeA6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 4, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife A")

# Knife B 3-Month Survey
knifeB3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 5, 
                          range = 'C2:Q124',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife B")

# Knife B 6-Month Survey
knifeB6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 6, 
                          range = 'C2:Q115',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife B")

# Knife C 3-Month Survey
knifeC3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                    sheet = 7, 
                    range = 'A2:Z86',
                    col_names = c("date", "bond", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "competition", "sedimentation", "unknown", "n_stressors"))%>%
            mutate(site = "Knife C")

# Knife C 6-Month Survey
knifeC3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                    sheet = 8, 
                    range = 'A2:Z86',
                    col_names = c("date", "bond", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "competition", "sedimentation", "unknown", "n_stressors"))%>%
            mutate(site = "Knife C")

# Oil Slick 1-Month Survey
oilslick1 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Oil Slick Leap")

# Oil Slick 7-Month Survey
oilslick7 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Oil Slick Leap")

# Oil Slick 13-Month Survey
oilslick13 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 4, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Oil Slick Leap")

# South Bay II .5-Month Survey
southbay0.5 <- read_excel("South Bay II Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q67',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "South Bay II")

# South Bay II 18-Month Survey
southbay18 <- read_excel("South Bay II Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q71',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "South Bay II")
```


```{r creating functions}

# Calculating average tissue health function.
tissue_health <- function(x) {
x %>%
  select(species, duration, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100, site) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.375, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.625, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)
}

# Calculating aggregate table function.  Must take tissue_health function input.
agg_table <- function(x) {
x %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
              mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
              avg_health = mean(weighted_health)) %>%
    arrange(mortality_rate)
}

# Creating ggplot function for mortality rate plot.
gg_mortality <- function(x,...) {
ggplot(x, aes(x=factor(geno), y=mortality_rate, fill= mortality_rate)) +
  geom_col() +
  scale_y_continuous(labels=scales::percent_format(scale=1)) +
  labs(x="Genotype", 
       y="Mortality Rate",
       fill="Genotype") + 
  theme(legend.position = "none") +
    theme(plot.title = element_text(face = "italic"))
}

# Creating ggplot function for average tissue health plot.
gg_tissue_health <- function(x,...) {
  ggplot(x, aes(x = factor(geno), y = weighted_health)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Genotype", 
       y = "Percent of Healthy Tissue") + 
    theme(plot.title = element_text(face = "italic"))
}

#Creating function for nice_table formatting. Input must be the aggregate object.
table_format <- function(x) {
x$mortality_rate <- paste0(round(x$mortality_rate, 2), "%")
x$avg_health <- paste0(round(x$avg_health, 2), "%")
x %>% rename("Species" = species, 
                      # "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
  nice_table() %>%
  colformat_num(digits = 1)
}

```


![](/Users/tadgemcwilliams/Documents/Data Science/Reef Renewal Bonaire/RRFB/Carl's Hill_IG.jpg)

## Summary

## Methodology

This analysis is intended to adhere to the guidance proposed by the National Oceanic & Atmospheric Association (NOAA) in its September 2020 technical memorandum *Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local Ecosystem Scales.* All data was provided by RRB.  The ecological footprint data was collected from photomosaics and traditional underwater surveying methods.  The site-specific data was provided after detailed surveys of the outplanted sites.  
Mortality rates are a standard calculation of (corals present - dead corals) / corals outplanted.  Average tissue health is calculated as a weighted average of five tissue-health categories.  Corals are partitioned into tissue health groups of 1-25%, 26-50%, 51-75%, 76-99%, and 100%.  The central point of each category (12.5%, 37.5%, 62.5%, 87%, and 100%) is used to calculate the average tissue health.  This calculation does not include dead observations or those with 0% tissue health.[^1]
All calculations and visualizations are performed using R.  R packages for this project include *knitr*, *readxl*, *tidyverse*, *flextable*, and *rempsyc*.  The report is formatted in Markdown, and all versions have been pushed to a GitHub repository.

[^1]: Goergen, E.A., Schopmeyer, S., Moulding, A.L., Moura, A., Kramer, P., and Viehman, T.S. 2020. Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local to Ecosystem Scales. NOAA Technical Memorandum NOS NCCOS 279. Silver Spring, MD. 158 pp. https://doi.org/10.25923/xndz-h538

## Overview of Restoration Efforts

## Species: Acer
Mi Dushi I: 13-month
Punt Vierkant: 3-month, 6-month
Yellowman A: 3-month, 6-month
Yellowman B: 3-month, 6-month
Yellowman C: 3-month

### Acer Overview

```{r combining acer sites}
# Aligning class types
puntv3$cluster <- str_remove_all(puntv3$cluster, "C") %>% as.numeric()
puntv6$cluster <- str_remove_all(puntv6$cluster, "C") %>% as.numeric()
yellowmanA3$date <- as.POSIXct(yellowmanA3$date)
yellowmanA3$cluster <- str_remove_all(yellowmanA3$cluster, "C") %>% as.numeric()
yellowmanA6$cluster <- str_remove_all(yellowmanA6$cluster, "C") %>% as.numeric()
yellowmanB3$date <- as.POSIXct(yellowmanB3$date)
yellowmanB3$cluster <- str_remove_all(yellowmanB3$cluster, "C") %>% as.numeric()

# Binding Acer rows.
acer_all <- bind_rows(midushi13, puntv3, puntv6, yellowmanA3, yellowmanA6,
                      yellowmanB3, yellowmanB6, yellowmanC3) 

# Changing duration to numeric.
acer_all$duration <- acer_all$duration %>% str_remove_all("M") %>% as.numeric()

```

```{r plotting distribution of acer_all data}

acer_all %>%
  group_by(species, site, duration) %>%
  ggplot(aes(x=site, fill = factor(duration))) +
  geom_bar() +
  scale_fill_brewer(palette = "Paired", direction = -1) +
  labs(x = "Site",
       y = "Count",
       fill = "Survey Month",
       title="Distribution of Acer Data") + 
    theme(plot.title = element_text(face = "italic"))
```



```{r plotting acer_all data}
acer_latest <- acer_all %>%
  group_by(species, site) %>%
  filter(duration == max(duration))

acer_latest %>%
  tissue_health() %>%
  agg_table() %>%
  gg_mortality() +
  scale_fill_viridis(discrete = FALSE, option = "turbo") +
  theme(legend.position = "right") +
  labs(fill = "Mortality Rate",
       title = "Acer Mortality Rate",
        caption = "As of latest site survey.")

acer_latest %>%
  tissue_health() %>%
  group_by(geno) %>%
  mutate(med_tissue = median(weighted_health)) %>%
  ggplot(aes(x = factor(geno), y = weighted_health, fill = med_tissue)) +
  geom_boxplot() +
  scale_fill_viridis(discrete = FALSE, option = "mako") +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Genotype", 
       y = "Percent of Healthy Tissue",
       fill = "Median Health",
       title = "Acer Average Tissue Health",
       caption = "As of latest site survey.") + 
    theme(plot.title = element_text(face = "italic"))

```

```{r acer mortality by site}
acer_latest %>%
  tissue_health() %>%
  group_by(species, site) %>%
   summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
              mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
              avg_health = mean(weighted_health)) %>%
  arrange(desc(mortality_rate)) %>%
  rename("Site" = site) %>%
  table_format()
  
```


```{r acer mortality by geno and site}

acer_latest %>%
  tissue_health() %>%
  group_by(species, site, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
            avg_health = mean(weighted_health)) %>%
  arrange(mortality_rate) %>%
  ggplot(aes(x=factor(geno), y=mortality_rate, fill=site)) +
    geom_col(position = "dodge") +
    facet_grid(~geno, scales = "free") +
    #scale_fill_brewer(palette = "GnBu") +
    #scale_fill_viridis(discrete = TRUE, option = "mako") +
    scale_y_continuous(labels=scales::percent_format(scale=1)) +
    labs(x="Genotype", 
       y="Mortality Rate",
       fill="",
       title="Genomic Mortality Rate by Site",
       caption="As of latest site survey.") + 
    theme(plot.title = element_text(face = "italic"),
          legend.position="bottom")
    
```



```{r acer 3- to 6-month changes}
comparison_sites <- c("Punt Vierkant", "Yellowman A", "Yellowman B")

acer_all %>%
  filter(site %in% comparison_sites) %>% 
  tissue_health() %>%
  group_by(species, duration, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
            avg_health = mean(weighted_health)) %>%
  ggplot(aes(x = factor(geno), y = mortality_rate)) +
    geom_point(aes(color = factor(duration))) +
    geom_line(arrow = arrow(length=unit(0.25,"cm"), ends="last", type = "open")) +
    scale_y_continuous(limits = c(0, 100), 
                     breaks = seq(0, 100, by = 5)) 
```



## Species: Apal
Carl’s Hill: 3-month, 6-month
Knife I A: 1-month, 5-month, 6-month
Knife I B: 3-month, 6-month
Knife I C: 3-month, 6-month
Oil Slick: 1-month, 7-month, 13-month
Southbay II: 0.5-month, 18-month

## Actionable Opportunities
Glue: Cement vs Epoxy

## Conclusions
