---
title: "Improving Reef Resilience with Portfolio Analysis"
subtitle: "A Collaboration with Reef Renewal Bonaire"
author: "Tadge McWilliams"
date: "2023-11-13"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

![](/Users/tadgemcwilliams/Documents/Data Science/Reef Renewal Bonaire/RRFB/Carl's Hill_IG.jpg)

## Summary

Coral reefs are a bellwether for the health of the oceans and provide an important leading indicator for the effects of climate change. They are also under intense pressure.  

Organizations around the world are working on studying and building up coral reefs. Their goals are to stabilize their territories, while improving their health and resilience. Yet, coral reef restoration is largely under-valued and under-funded by much of the world.  The ability to propagate and grow new coral reefs is a vital tool in the fight to manage our changing climate.  With limited resources, constraints cannot be ignored.  Outplanting new reefs must be done with maximum efficiency.  

This report attempts to demonstrate an innovative application of financial portfolio analysis to construct a genomic portfolio from which organizations may optimize their resources and outplant new reefs with increased efficiency.  The models developed for two coral species show that improvements to overall reef survival rates are possible when the proportions of genotypes are weighted to achieve the desired portfolio goals.  The models suggest that immediate gains can be made.  Further analysis will support hypertuning the models and the long-term success of the reefs.

## Methodology

_Approach:_ Initial analysis adheres to the guidance proposed by the National Oceanic & Atmospheric Association (NOAA) in its September 2020 technical memorandum *Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local Ecosystem Scales.* 

_Data:_ All data was provided by Reef Renewal Bonaire (RRB).  The ecological footprint data was collected from photomosaics and traditional underwater surveying methods.  The site-specific data was provided from detailed underwater surveys of the outplanted reefs  

_Coral cover percentage_ is calculated as (total coral area / eco-footprint) * 100.

_Mortality rates_ are a standard calculation of (corals present - dead corals) / corals outplanted.

_Average tissue health_ is calculated as a weighted average of five tissue-health categories.  Corals are partitioned into tissue health groups of 1-25%, 26-50%, 51-75%, 76-99%, and 100%.  The central point of each category (12.5%, 37.5%, 62.5%, 87%, and 100%) is used to calculate the average tissue health.  This calculation does not include dead observations or those with 0% tissue health.[^1]

_Calculations and visualizations_ are performed using R.  R packages for this project include *knitr*, *readxl*, *tidyverse*, *plotly*, *flextable*, and *PortfolioAnalytics*.  The report is formatted in Markdown, and all versions have been pushed to GitHub.

[^1]: Goergen, E.A., Schopmeyer, S., Moulding, A.L., Moura, A., Kramer, P., and Viehman, T.S. 2020. Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local to Ecosystem Scales. NOAA Technical Memorandum NOS NCCOS 279. Silver Spring, MD. 158 pp. https://doi.org/10.25923/xndz-h538


```{r global settings, setup, include=FALSE}
library(knitr) #global settings
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')
```

```{r, load libraries, include=FALSE}
library(readxl)
library(tidyverse)
library(pander)
library(flextable)
library(rempsyc)
library(RColorBrewer)
#display.brewer.all(colorblindFriendly = TRUE)
library(viridisLite)
library(viridis)
library(plotly)
library(trelliscopejs)
library(PortfolioAnalytics)
```

```{r, loading data}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")

###Monitoring Summary
ltsummary <- read_excel("Monitoring Summary.xlsx", 
                    sheet = 2, 
                    range = 'A3:L28',
                    col_names = c("site_name", "site_code", "species", "subsite",
                                  "survey_date","time_code", "eco_footprint",
                                  "tot_coral_area", "restored_area", "perc_coral_cover", 
                                  "coral_density", "restored_size_cm"))

eco_summary <- read_excel("Monitoring Summary.xlsx", 
                    sheet = 4, 
                    range = 'A2:D44',
                    col_names = c("site_name", "site_code", "year", "eco_footprint"))

##### Acer Data
# Mi Dushi I Survey
midushi13 <- read_excel("Mi Dushi I Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q71',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor")) %>%
            mutate(site = "Mi Dushi")

# Punt Vierkant 3-Month Survey
puntv3 <- read_excel("PV_Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'A2:Y92',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Punt Vierkant")

# Punt Vierkant 6-Month Survey
puntv6 <- read_excel("PV_Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:Y92',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Punt Vierkant")

# Yellowman A 3-Month Survey
yellowmanA3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor")) %>%
            mutate(site = "Yellowman A")

# Yellowman A 6-Month Survey
yellowmanA6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor")) %>%
            mutate(site = "Yellowman A")

# Yellowman B 3-Month Survey
yellowmanB3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 4, 
                    range = 'A2:Y83',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Yellowman B")

# Yellowman B 6-Month Survey
yellowmanB6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 5, 
                    range = 'A2:Z82',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", "bottom_contact", 
                                  "fireworm", "snail", "cyanob", "competition", "unknown", "n_stressors")) %>%
            mutate(site = "Yellowman B")

# Yellowman C 3-Month Survey
yellowmanC3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 6, 
                    range = 'A2:Z34',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", 
                                  "bottom_contact", "fireworm", "snail", "cyanob", "competition", "unknown",
                                  "n_stressors")) %>%
            mutate(site = "Yellowman C")

#### Apal Data
# Carl 3-Month Survey
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors")) %>%
            mutate(site = "Carl's Hill")

# Carl 6-Month Survey
carl6 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 3, 
                    range = 'A2:Z51',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cyanob", "sedimentation", "unknown", "n_stressors")) %>%
            mutate(site = "Carl's Hill")

# Knife A 3-Month Survey
knifeA3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Knife A")

# Knife A 5-Month Survey
knifeA5 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife A")

# Knife A 6-Month Survey
knifeA6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 4, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife A")

# Knife B 3-Month Survey
knifeB3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 5, 
                          range = 'C2:Q124',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife B")

# Knife B 6-Month Survey
knifeB6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 6, 
                          range = 'C2:Q113',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))%>%
            mutate(site = "Knife B")

# Knife C 3-Month Survey
knifeC3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                    sheet = 7, 
                    range = 'A2:Z83',
                    col_names = c("date", "bond", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "competition", "sedimentation", "unknown", "n_stressors"))%>%
            mutate(site = "Knife C",
                   duration = "3M")

# Knife C 6-Month Survey
knifeC6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                    sheet = 8, 
                    range = 'A2:Z86',
                    col_names = c("date", "bond", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "competition", "sedimentation", "unknown", "n_stressors"))%>%
            mutate(site = "Knife C", 
                   duration = "6M")

# Oil Slick 1-Month Survey
oilslick1 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Oil Slick Leap")

# Oil Slick 7-Month Survey
oilslick7 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Oil Slick Leap")

# Oil Slick 13-Month Survey
oilslick13 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 4, 
                          range = 'C2:Q26',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "Oil Slick Leap")

# South Bay II .5-Month Survey
southbay0.5 <- read_excel("South Bay II Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q67',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "South Bay II")

# South Bay II 18-Month Survey
southbay18 <- read_excel("South Bay II Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q62',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor")) %>%
            mutate(site = "South Bay II")
```


```{r creating functions}

# Calculating average tissue health function.
tissue_health <- function(x) {
x %>%
  select(species, duration, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100, site) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.375, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.625, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)
}

# Calculating aggregate table function.  Must take tissue_health function input.
agg_table <- function(x) {
x %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
              mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
              avg_health = mean(weighted_health)) %>%
    arrange(mortality_rate)
}

#Creating function for nice_table formatting. Input must be the aggregate object.
table_format <- function(x) {
x$mortality_rate <- paste0(round(x$mortality_rate, 2), "%")
x$avg_health <- paste0(round(x$avg_health, 2), "%")
x %>% rename("Species" = species, 
                      # "Geno" = geno, 
                       "Outplanted" = num_outplanted, 
                       "Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
  nice_table() %>%
  colformat_num(digits = 1)
}

```

## Eco-Footprint

```{r, foramtting Ltsummary}
### Removing NAs  
ltsummary <- ltsummary %>% select(-subsite) %>% drop_na(eco_footprint)

```

The following visuals highlight the changes in ecological footprints and total coral coverage from year to year.  Data from RRB's long-term surveys is used for this section.  As new outplanting sites are created each year, not all sites have been equally surveyed.  

<br>

```{r ecological footprint}

eco_summary %>%
  plot_ly(x = ~year, y = ~eco_footprint, color = ~site_name,
          mode = "lines+markers",
          hoverinfo = "text",
          text = ~paste0("Site: ", site_name, "<br>",
                         "Year: ", year, "<br>",
                         "Eco-footprint: ", eco_footprint)) %>%
  layout(xaxis = list(title = "Year"),
         yaxis = list(title = "Eco-Footprint (m)"),
         title = "Change in Ecological Footprint Over Time")

eco_summary %>%
  ggplot(aes(x = year, y = eco_footprint)) +
  geom_line() +
  geom_point() + 
  facet_wrap(~site_name) +
  labs(x = "Year",
       y = "Eco-Footprint (m)",
       title = "Change in Eco-Footrpint by Site") +
  theme(plot.title = element_text(hjust = 0.5))

```


In the visual below, I plot the change in coral cover as a percentage by site.  As previously noted, this calculation is the total area of coral cover, divided by the size of the eco-footprint.  It represents the density of coral coverage for a given site.

<br>

```{r, eco growth by metric, message=FALSE}

ltsummary %>%
  mutate(coral_cover = (tot_coral_area / eco_footprint)*100) %>%
  plot_ly(x = ~survey_date, y = ~coral_cover, color = ~site_name, mode = "lines+markers",
          hoverinfo = "text",
          text = ~paste0("Site: ", site_name, "<br>",
                         "Year: ", year(survey_date), "<br>",
                         "Coral Cover: ", round(coral_cover,2), "%")) %>%
  layout(xaxis = list(title = "Year"),
         yaxis = list(title = "Coral Cover (%)"),
         title = "Change in Coral Cover Over Time")

```


## Species: Acer

The Acropora cervicornis (Acer) species, commonly known as Staghorn Coral, has been outplanted at the following sites: Mi Dushi, Punt Vierkant, Yellowman A, B, and C.  The Mi Dushi survey was taken 13 months after outplanting.  Data was provided from three- and six-month surveys for Punt Vierkant, Yellowman A, and Yellowman B.  All data utilized from Yellowman C is from a three-month survey.

```{r combining acer sites}
# Aligning class types
puntv3$cluster <- str_remove_all(puntv3$cluster, "C") %>% as.numeric()
puntv6$cluster <- str_remove_all(puntv6$cluster, "C") %>% as.numeric()
yellowmanA3$date <- as.POSIXct(yellowmanA3$date)
yellowmanA3$cluster <- str_remove_all(yellowmanA3$cluster, "C") %>% as.numeric()
yellowmanA6$cluster <- str_remove_all(yellowmanA6$cluster, "C") %>% as.numeric()
yellowmanB3$date <- as.POSIXct(yellowmanB3$date)
yellowmanB3$cluster <- str_remove_all(yellowmanB3$cluster, "C") %>% as.numeric()

# Binding acer rows.
acer_all <- bind_rows(midushi13, puntv3, puntv6, yellowmanA3, yellowmanA6,
                      yellowmanB3, yellowmanB6, yellowmanC3) %>%
            arrange(date)

# Changing duration to numeric.
acer_all$duration <- acer_all$duration %>% str_remove_all("M") %>% as.numeric()

```

### Acer Summary

Below is a distribution of survey data collected by site and survey-date since outplanting.

<br>

```{r plotting distribution of acer_all data}

acer_all %>%
  group_by(species, site, duration) %>%
  ggplot(aes(x=site, fill = factor(duration))) +
  geom_bar() +
  scale_fill_brewer(palette = "Paired", direction = -1) +
  labs(x = "Site",
       y = "Count",
       fill = "Survey Month",
       title="Distribution of Acer Data") +
  theme(plot.title = element_text(hjust = 0.5))
```


The table below lists summary statistics for each Acer site.

<br>

```{r acer mortality by site}

acer_latest <- acer_all %>%
  group_by(species, site) %>%
  filter(duration == max(duration))

acer_latest %>%
  tissue_health() %>%
  group_by(species, site) %>%
   summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
              mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
              avg_health = mean(weighted_health)) %>%
  arrange(desc(mortality_rate)) %>%
  rename("Site" = site) %>%
  table_format()
  
```

#### Acer Mortality Rates

The plots below highlight differences on the genomic level.  Data is utilized from each site.  When multiple surveys were provided for a single site, the latest (most recent) data was used to avoid duplication.  Specifically, the three-month surveys for Punt Vierkant, Yellowman A, and Yellowman B were omitted in favor of using the six-month survey data.  The result is a snap shot of current conditions.

Genos #3, #9, #14, and #22 have the highest mortality rates.  This corresponds with the average tissue health, indicating these are perhaps the least successful genos.  Conversely, genos #7-8, #12, #24, and #26 have performed better than others.  

<br>

```{r plotting acer_all data}

# Mortality plot.
acer_mortality.plot <- acer_latest %>%
  tissue_health() %>%
  agg_table() %>%
  ggplot(aes(x = factor(geno), y = mortality_rate, fill = mortality_rate)) +
  geom_col(aes(text= paste0("Mortality Rate: ", round(mortality_rate,2), "%"))) +
  scale_y_continuous(labels=scales::percent_format(scale=1)) +
  labs(x="Genotype", 
       y="Mortality Rate",
       fill="Genotype") + 
  theme(legend.position = "none") +
  scale_fill_viridis(discrete = FALSE, option = "turbo") +
  theme(legend.position = "right") +
  labs(fill = "Mortality Rate",
       title = "Acer Mortality Rate",
        caption = "As of latest site survey.") +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(acer_mortality.plot, tooltip = "text")

```

Below, I isolate the data for sites with both three- and six-month surveys (Punt Vierkant, Yellowman A, and Yellowman B) and plot the change in mortality rate over time.  The data indicates that while a three-month survey may be reasonable for determining the success of some genos, others (#9, #14, #22, and #25, for example) may take longer to establish.

<br>

```{r acer 3- to 6-month mortality}
comparison_sites <- c("Punt Vierkant", "Yellowman A", "Yellowman B")

acer_comp1 <- acer_all %>%
  filter(site %in% comparison_sites) %>% 
  group_by(species, duration, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100)

acer_comp2 <- acer_comp1 %>% filter(duration == 3)

acer_comp2 %>%
  plot_ly(x = ~factor(geno), 
          y = ~mortality_rate, 
          hoverinfo = "text", 
          hovertext = ~paste0("Mortality Rate: ", round(mortality_rate,2), "%")) %>%
  add_markers(marker = list(color = toRGB("gray15"), size = 5)) %>%
  add_bars(data = acer_comp1, color = ~factor(geno), frame = ~duration) %>%
  layout(xaxis = list(title = "Acer Genotype"),
         yaxis = list(title = "Mortality Rate"),
         title = "How Does Mortality Rate Change Over 3 Months?",
          plot_bgcolor = "whitesmoke") %>%
  animation_slider(currentvalue = list(prefix = "Survey Month: ")) %>%
  hide_legend()
  
```

Separating the mortality rate findings by site reveals which sites have performed better than others.  That said, it is important to note that not all sites contain all genos.  Hence, site statistics may be skewed by a greater number of poorly performing genos as they cannot be held equal.
<br>
*Note: Clicking on the legend names allows you to filter the chart.*

<br>

```{r acer mortality by geno and site}

acer_latest %>%
  tissue_health() %>%
  group_by(species, site, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
            avg_health = mean(weighted_health)) %>%
  arrange(mortality_rate) %>%
  plot_ly(x = ~factor(geno), 
          y = ~mortality_rate, 
          color = ~site, 
          hoverinfo = "text", 
          text = ~paste0("Site: ", site, "<br>",
                         "Geno: ",geno, "<br>", 
                         "Mortality Rate: ", round(mortality_rate, 2), "%")) %>%
    add_bars(width = 0.5, position = "jitter") %>%
    layout(xaxis = list(title = "Acer Genotype"),
           yaxis = list(title = "Mortality Rate"),
           title = "Acer Mortality Rate by Site",
           legend = list(x=1, y=.5, title = list(text = "Site")),
            plot_bgcolor = "whitesmoke")

```

#### Acer Tissue Health

The average tissue health for each geno generally corresponds with the mortality rate.  Genos #9, #14, and #22 have not performed as well as others in either measure.  It is worth mentioning that genos #3 and #6 (each with higher mortality rates) have good average tissue health if outliers are omitted.

<br>

```{r acer tissue health by geno}

acer_health.plot <- acer_latest %>%
  tissue_health() %>%
  group_by(geno) %>%
  mutate(med_tissue = median(weighted_health))

plot_ly(acer_health.plot, 
        x = ~factor(geno),
        y = ~weighted_health) %>%
  add_boxplot() %>%
  layout(xaxis = list(title = "Acer Genotype"),
         yaxis = list(title = "Acer Average Tissue Health"),
         title = "Acer Average Tissue Health") %>%
  hide_legend()

```

The graph below is a raw breakdown of average tissue health by geno and by site.  Each recorded observation is plotted.  Filtering the data to view individual sites helps to identify the distribution of observations by geno.
<br>
*Note: Clicking on the legend names allows you to filter the chart.*

<br>

```{r acer tissue health by site}

acer_latest %>%
  tissue_health() %>%
  plot_ly(x = ~factor(geno),
          y = ~weighted_health,
          color = ~site,
          hoverinfo = "text",
          text = ~paste0("Site: ", site, "<br>",
                         "Geno: ", geno,  "<br>",
                         "Tissue Health: ", round(weighted_health, 2), "%")) %>%
  add_markers() %>%
  layout(xaxis = list(title = "Acer Genotype<br>"),
         yaxis = list(title = "Percent of Healthy Tissue"),
         title = "Acer Tissue Health by Site",
         legend = list(x=1, y=.5, title = list(text = "Site")),
         plot_bgcolor = "whitesmoke")

```

A negative correlation between mortality rate and tissue health exists.  The linear regression line below highlights the relationship.  I use an ANOVA test to confirm the regression model is statistically significant. 

<br>

```{r acer mortality vs tissue health}

acer4model <- acer_all %>%
  tissue_health() %>%
  group_by(species, site, geno, duration) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
            avg_health = mean(weighted_health)) %>%
  arrange(mortality_rate) 

print(paste0("The correlation between mortality rate and tissue health is ", round(cor(acer4model$mortality_rate, acer4model$avg_health),3), "."))
             
acermod <- lm(mortality_rate ~ avg_health, data = acer4model)
acermod
anova(acermod)

ggplot(acer4model, aes(x = mortality_rate, y = avg_health)) +
  geom_point(aes(shape = site, color = site)) +
  geom_smooth(se = FALSE, method = lm, color = "cornflowerblue") +
  labs(x = "Mortality Rate",
         y = "Average Tissue Health",
         color = "Site",
         shape = "Site",
         title = "Acer Tissue Health vs. Mortality Rate") +
  theme(plot.title = element_text(hjust = 0.5))

```

### Acer Portfolio Analysis

The goals of RRB are to successfully outplant as many corals as possible and also to ensure new reefs are genomically diverse.  Thus, a driving question is how to achieve both goals with maximum efficiency of resources.  Though one strategy would be to outplant an equal number of corals from each genotype, the data shows that not all genotypes are equally resilient.  Because of this,  inefficiencies to production are introduced.  Therefore, I propose building a weighted portfolio of genotypes in a similar manor as one builds a financial portfolio of investments.

In typical portfolio analysis, the primary factors to consider are the return on investment for each account and a measure of risk (typically, the standard deviation of average returns is used).  From these factors, an optimal basket of accounts is selected to achieve the desired portfolio goals.  In a portfolio of genotypes, I propose using the inverse mortality rate (the survival rate) as the return on investment.  For example, geno #1 has an average mortality rate of 3.11%; therefore, there is a 96.89% survival rate (the return on investment).  Similarly, geno #3 has a 21.54% average mortality rate, and so there is a 78.46% average return.  The standard deviation of the average returns is calculated for each genomic group as the measure of risk.

Below, I plot the distribution of observations by genotype to visualize the raw sample size.

<br>

```{r acer creating portfolio}
# Creating tidy acer portfolio.
acer.port <- acer_all %>%
  tissue_health() %>%
  mutate(mortality_rate = (n_outplanted-(n_present - health_0)) / n_outplanted,
         returns = 1 - mortality_rate) %>% 
  select(geno, weighted_health, mortality_rate, returns)

acer.port$mortality_rate <- replace_na(acer.port$mortality_rate, 0)
acer.port$returns <- replace_na(acer.port$returns, 1) 

# Reviewing distribution of data.
acer.port %>% 
  count(geno) %>%
  mutate(percent = paste0(round(100 * n / sum(n),2),"%")) %>%
  plot_ly(x = ~factor(geno), y = ~n, hoverinfo = "text",
          hovertext = ~paste0("Observations: ", n, "<br>",
                          "Percent of Total: ", percent, "%", "<br>")) %>%
  add_bars() %>%
  layout(xaxis = list(title = "Acer Genotypes"),
        yaxis = list(title = "Observations"),
        title = "Distribution of Observations") %>%
  hide_legend()


# Creating aggregate portfolio by geno.
acer.port.agg <- acer.port %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health),
            avg_mortality = mean(mortality_rate),
            avg_returns = mean(returns),
            sd = sd(returns),
            observations = n())

```

Additionally, the chart below shows the relationship between average return and standard deviation.

<br>

```{r acer portolio return vs sd }

plot_ly(acer.port.agg, x = ~sd, 
                      y = ~avg_returns, 
                      color = ~factor(geno),
                      hoverinfo = "text", 
                      text = ~paste0("Geno: ", geno, "<br>",
                                     "Observations: ", observations, "<br>",
                                    "Average Return: ", round(avg_returns,3), "<br>",
                                    "Standard Deviation: ", round(sd, 3))) %>%
                    add_markers(size = ~observations) %>%
                    layout(xaxis = list(title = "Standard Deviation"),
                           yaxis = list(title = "Acer Average Returns"),
                           title = "How Acer Risk and Return Are Related") %>%
                    hide_legend()

# Reviewing distribution of returns for each geno with trelliscope.
# acer.port %>% ggplot(aes(x = returns)) + geom_histogram() + facet_trelliscope(~geno)

```

#### Acer Bootstrapping

Having a sufficiently large sample size to calculate accurate returns and risk is important.  Because the sample size of some genotypes is limited, I use "bootstrapping" to artificially expand the sample size.  Each genotype group is randomly sampled 1000 times with replacement.  The result is a larger sample of the original data.  Through the Central Limit Theorem, the average returns for each genotype within the bootstrapped data set approaches a normal distribution.  Thus, the distribution of returns are closer to the sample means and the risk factors (standard deviations) are more closely representative of the population.

<br>

```{r acer bootstrapping portfolio}

# Creating bootstrap data set.
acer.boot <- replicate(n = 1000, simplify = FALSE, expr = {
  acer.port %>%
  group_by(geno) %>%
  slice_sample(prop = 1, replace = TRUE)
 }) %>%
  bind_rows()

# Summarizing bootstrapped data by geno.
acer.boot.agg <- acer.boot %>%
  summarize(avg_health = mean(weighted_health),
         avg_mortality = mean(mortality_rate),
         avg_returns = mean(returns),
         sd = sd(returns),
         observations = n())

```


**Summary of Raw Data**
```{r acer portfolio raw table}
# Raw data summary
print(summary(acer.port.agg[,4:6]))

```

**Summary of Bootstrapped Data**
```{r acer portfolio bootstrap table}

# Boostrapped data summary
summary(acer.boot.agg[,4:6])

# Checking for normal distribution.
#acer.boot %>% ggplot(aes(x = returns)) + geom_histogram() + facet_trelliscope(~geno)
  
```


#### Acer Portfolio

I use the Portfolio Analytics' *optimize.portfolio* function on the bootstrapped data set to calculate the optimal weights of each genotype in the portfolio.  Portfolio specifications are added to ensure that 1)the portfolio is fully invested as a long-only fund, whereby the sum of weights total to 1.0 (or 100%), 2)returns are defined as the mean survival rate and risk is defined as the standard deviation from the means, and 3)each genotype makes up a minimum of 1% of the total portfolio and a maximum of 25%.  The model iterates 20,000 times over the possible weight combinations until an optimal portfolio is achieved.

Note that the minimum and maximum weight constraints were chosen without scientific knowledge or expertise in determining a given genomic diversity target.  Tightening or relaxing these constraints will hinder or improve, respectively, the degree of optimization.

The outputs below identify the optimal weights for each genotype as well as the anticipated portfolio return and risk.  Additionally, the scatterplot highlights the optimal portfolio against other iterations of the model.  

<br>

```{r acer portfolio analysis}

acer.returns.wide <- acer.boot %>%
  select(geno, returns) %>%
  group_by(geno) %>%
  mutate(row = row_number()) %>%
  pivot_wider(names_from = geno, values_from = returns) %>%
  select(-row)

acer.returns.wide <- as.ts(acer.returns.wide)
port_spec <- portfolio.spec(assets = colnames(acer.returns.wide))
port_spec <- add.constraint(portfolio = port_spec, type = "full_investment")
port_spec <- add.constraint(portfolio = port_spec, type = "long_only")
port_spec <- add.objective(portfolio = port_spec, type = "return", name = "mean")
port_spec <- add.objective(portfolio = port_spec, type = "risk", name = "StdDev")
port_spec <- add.constraint(portfolio = port_spec, type = "box",
                                  min = 0.01, max = 0.25, 
                                  indexnum = 2)

set.seed(2)
acer.opt <- optimize.portfolio(acer.returns.wide,
                          portfolio = port_spec,
                          optimize_method = "random",
                          search_size = 20000,
                          trace = TRUE)

# Visualizing results.
acer.opt
chart.Weights(acer.opt)
chart.RiskReward(acer.opt, risk.col = "StdDev", return.col = "mean", chart.assets = FALSE,
                 main = "Optimal Acer Portfolio")

```

The model predicted survival rate (mean return) and risk (standard deviation) are improvements on the existing statistics.  By outplanting future Acer sites with the optimal genomic weights, this model suggests that survival rates can be increased.  A comparison between the existing values and the optimized portfolio is below.

<br>

```{r acer portfolio improvements}

opt.table <- c(acer.opt$opt_values$mean, acer.opt$opt_values$StdDev[1])

acer.comparison <- acer.boot.agg %>%
  summarize(mean = mean(avg_returns),
            StdDev = mean(sd)) %>%
  bind_rows(opt.table) %>% 
  t() %>% 
  as.tibble() %>%
  mutate(change = abs(V2 - V1))


acer.comparison <- as.data.frame(acer.comparison)
colnames(acer.comparison) <- c("Current Portfolio", "Optimal Portfolio", "Improvement")
rownames(acer.comparison) <- c("Acer Survival Rate", "Acer Risk")
acer.comparison <- round(acer.comparison, 4) * 100

kable(acer.comparison)

```

## Species: Apal

The Acropora palmata (Apal) speices, commonly known as Elkhorn coral, has been outplanted at the following sites: Carl's Hill, Knife (subsites A-C), Oil Slick Leap, and South Bay II.

The Carl's Hill, Knife B, and Knife C surveys were taken three and six months after outplanting.  Data was provided from one-, five-, and six-month surveys of Knife A.  Data from Oil Slick Leap was collected one, seven, and 13 months after outplanting, and the Southbay II data was collected at one half-month and 18 months from outplanting.

<br>

```{r combining apal sites}

# Aligning class types
carl3$cluster <- str_remove_all(carl3$cluster, "C") %>% as.numeric()
knifeA3$cluster <- str_remove_all(knifeA3$cluster, "C") %>% as.numeric()
knifeA5$cluster <- str_remove_all(knifeA5$cluster, "C") %>% as.numeric()
knifeA6$cluster <- str_remove_all(knifeA6$cluster, "C") %>% as.numeric()
knifeB3$cluster <- str_remove_all(knifeB3$cluster, "C") %>% as.numeric()
knifeB6$cluster <- str_remove_all(knifeB6$cluster, "C") %>% as.numeric()
knifeB6$geno <- as.numeric(knifeB6$geno)
knifeC3$cluster <- as.numeric(knifeC3$cluster)
knifeC3$n_outplanted <- as.numeric(knifeC3$n_outplanted)
knifeC6$n_outplanted <- as.numeric(knifeC6$n_outplanted)
southbay0.5$cluster <- str_remove_all(southbay0.5$cluster, "C") %>% as.numeric()
southbay18$cluster <- str_remove_all(southbay18$cluster, "C") %>% as.numeric()

# Binding apal rows.
apal_all <- bind_rows(carl3, carl6, knifeA3, knifeA5, knifeA6, knifeB3, knifeB6, 
                      knifeC3, knifeC6, oilslick1, oilslick7, oilslick13, southbay0.5, 
                      southbay18) %>%
            arrange(date)

# Changing duration to numeric.
apal_all$duration <- apal_all$duration %>% str_remove_all("M") %>% as.numeric()

```

### Apal Summary

Below is a summary of the distribution of data collected.

<br>

```{r plotting distribution of apal_all data}

apal_all %>%
  group_by(species, site, duration) %>%
  ggplot(aes(x=site, fill = factor(duration))) +
  geom_bar() +
  scale_fill_brewer(palette = "Paired") +
  labs(x = "Site",
       y = "Count",
       fill = "Survey Month",
       title="Distribution of Apal Data") +
  theme(plot.title = element_text(hjust = 0.5))
```

The table below contains summary statistics for each Apal site.

<br>

```{r apal mortality by site}

apal_latest <- apal_all %>%
  group_by(species, site) %>%
  filter(duration == max(duration))

apal_latest %>%
  tissue_health() %>%
  group_by(species, site) %>%
   summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
              mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
              avg_health = mean(weighted_health)) %>%
  arrange(desc(mortality_rate)) %>%
  rename("Site" = site) %>%
  table_format()

```

#### Apal Mortality Rate

The plots below highlight differences on the genomic level.  As with the Acer data, when multiple surveys were provided for a site, the latest (most recent) data was used.  

Genos #16, #17, and #22 have the highest mortality rates.  Conversely, genos #9-10, and #13 have performed better than the rest.  

<br>

```{r plotting apal_all data}

# Mortality plot.
apal_mortality.plot <- apal_latest %>%
  tissue_health() %>%
  agg_table() %>%
  ggplot(aes(x = factor(geno), y = mortality_rate, fill = mortality_rate)) +
  geom_col(aes(text= paste0("Mortality Rate: ", round(mortality_rate,2), "%"))) +
  scale_y_continuous(labels=scales::percent_format(scale=1)) +
  labs(x="Genotype", 
       y="Mortality Rate",
       fill="Genotype") + 
  theme(legend.position = "none") +
  scale_fill_viridis(discrete = FALSE, option = "turbo") +
  theme(legend.position = "right") +
  labs(fill = "Mortality Rate",
       title = "Apal Mortality Rate",
        caption = "As of latest site survey.") +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(apal_mortality.plot, tooltip = "text")

```

I filter the Apal data to sites with both three- and six-month surveys (Carl's Hill, Knife B and Knife C) and plotted the change in mortality rate over time.  

Note that instances in which the mortality rate decreased over time correspond with a decrease in sample size.  For example, the three-month surveys of geno #23 has a total of 20 outplanted observations; however the six-month surveys show a total of only 10 outplanted observations.  It appears that not all clusters were re-surveyed.  Therefore, the comparison is not entirely inclusive of the same samples.

<br>

```{r apal 3- to 6-month mortality}

apal_durations <- c(3, 6)

apal_comp1 <- apal_all %>%
  filter(duration %in% apal_durations) %>%
  group_by(species, duration, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100)

apal_comp2 <- apal_comp1 %>% filter(duration == 3)

apal_comp2 %>%
  plot_ly(x = ~factor(geno), 
          y = ~mortality_rate, 
          hoverinfo = "text", 
          hovertext = ~paste0("Mortality Rate: ", round(mortality_rate,2), "%")) %>%
  add_markers(marker = list(color = toRGB("gray15"), size = 5)) %>%
  add_bars(data = apal_comp1, color = ~factor(geno), frame = ~duration) %>%
  layout(xaxis = list(title = "Apal Genotype"),
         yaxis = list(title = "Mortality Rate"),
         title = "How Does Mortality Rate Change Over 3 Months?",
          plot_bgcolor = "whitesmoke") %>%
  animation_slider(currentvalue = list(prefix = "Survey Month: ")) %>%
  hide_legend()

```

Separating the mortality rates by site reveals which sites have performed better than others.  Genos #6-11 have more stable mortality rates across sites than genos #2, 19, and 22.
<br>
*Note: Clicking on the legend names allows you to filter the chart.*

<br>

```{r apal mortality by geno and site}

apal_latest %>%
  tissue_health() %>%
  group_by(species, site, geno) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
            avg_health = mean(weighted_health)) %>%
  arrange(mortality_rate) %>%
  plot_ly(x = ~factor(geno), 
          y = ~mortality_rate, 
          color = ~site, 
          hoverinfo = "text", 
          hovertext = ~paste0("Site: ", site, "<br>",
                         "Geno: ",geno, "<br>", 
                         "Mortality Rate: ", round(mortality_rate, 2), "%")) %>%
    add_bars(width = 0.5, position = "jitter") %>%
    layout(xaxis = list(title = "Apal Genotype"),
           yaxis = list(title = "Mortality Rate"),
           title = "Apal Mortality Rate by Site",
           legend = list(x=1, y=.5, title = list(text = "Site")),
            plot_bgcolor = "whitesmoke")

```
#### Apal Tissue Health

The average tissue health for the Apal species is slightly higher than the Acer species.  Genos #2, #8, and #14 have not performed as well as others; however, the remaining genos are more tightly grouped when outliers are excluded.

<br>

```{r apal tissue health by geno}

apal_health.plot <- apal_latest %>%
  tissue_health() %>%
  mutate(med_tissue = median(weighted_health))

plot_ly(apal_health.plot, 
        x = ~factor(geno),
        y = ~weighted_health) %>%
  add_boxplot() %>%
  layout(xaxis = list(title = "Apal Genotype"),
         yaxis = list(title = "Apal Average Tissue Health"),
         title = "Apal Average Tissue Health") %>%
  hide_legend()

```
Filtering the breakdown of average tissue health by genotype and by site helps to identify the distribution of observations by geno.  Oil Slick Leap has the healthiest distribution of corals, while Carl's Hill and Knife A appear more widely distributed.
<br>
*Note: Clicking on the legend names allows you to filter the chart.*

<br>

```{r apal tissue health by site}

apal_latest %>%
  tissue_health() %>%
  plot_ly(x = ~factor(geno),
          y = ~weighted_health,
          color = ~site,
          hoverinfo = "text",
          text = ~paste0("Site: ", site, "<br>",
                         "Geno: ", geno,  "<br>",
                         "Tissue Health: ", round(weighted_health, 2), "%")) %>%
  add_markers() %>%
  layout(xaxis = list(title = "Apal Genotype<br>"),
         yaxis = list(title = "Percent of Healthy Tissue"),
         title = "Apal Tissue Health by Site",
         legend = list(x=1, y=.5, title = list(text = "Site")),
         plot_bgcolor = "whitesmoke")

```

As with the Acer data, a negative correlation between mortality rate and tissue health exists.  The linear regression line highlights this relationship. The ANOVA test confirms this model is also statistically significant. 

<br>

```{r apal mortality vs tissue health}

apal4model <- apal_all %>%
  tissue_health() %>%
  group_by(species, site, geno, duration) %>%
  summarize(num_outplanted = sum(n_outplanted),
            num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
            mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
            avg_health = mean(weighted_health)) %>%
  arrange(mortality_rate) 

print(paste0("The correlation between mortality rate and tissue health is ", round(cor(apal4model$mortality_rate, apal4model$avg_health),3), "."))
             
apalmod <- lm(mortality_rate ~ avg_health, data = apal4model)
apalmod
anova(apalmod)

ggplot(apal4model, aes(x = mortality_rate, y = avg_health)) +
  geom_point(aes(shape = site, color = site)) +
  geom_smooth(se = FALSE, method = lm, color = "cornflowerblue") +
  labs(x = "Mortality Rate",
         y = "Average Tissue Health",
         color = "Site",
         shape = "Site",
         title = "Apal Tissue Health vs. Mortality Rate") +
  theme(plot.title = element_text(hjust = 0.5))

```

### Apal Portfolio Analysis

The process for modeling the Apal portfolio is the same as for the Acer data.  The raw data is reviewed, bootstrapped, and modeled with the same portfolio goals.

<br>

```{r apal creating portfolio}
# Creating tidy apal portfolio.
apal.port <- apal_all %>%
  tissue_health() %>%
  mutate(mortality_rate = (n_outplanted-(n_present - health_0)) / n_outplanted,
         returns = 1 - mortality_rate) %>% 
  select(geno, weighted_health, mortality_rate, returns)

apal.port$mortality_rate <- replace_na(apal.port$mortality_rate, 0)
apal.port$returns <- replace_na(apal.port$returns, 1) 

# Reviewing distribution of data.
apal.port %>% 
  count(geno) %>%
  mutate(percent = paste0(round(100 * n / sum(n),2),"%")) %>%
  plot_ly(x = ~factor(geno), y = ~n, hoverinfo = "text",
          hovertext = ~paste0("Observations: ", n, "<br>",
                          "Percent of Total: ", percent, "%", "<br>")) %>%
  add_bars() %>%
  layout(xaxis = list(title = "Apal Genotypes"),
        yaxis = list(title = "Observations"),
        title = "Distribution of Observations") %>%
  hide_legend()


# Creating aggregate portfolio by geno.
apal.port.agg <- apal.port %>%
  group_by(geno) %>%
  summarize(avg_health = mean(weighted_health),
            avg_mortality = mean(mortality_rate),
            avg_returns = mean(returns),
            sd = sd(returns),
            observations = n())

```

The relationship between average return and standard deviation follows a more gentle slope than the Acer data.

<br>

```{r apal portolio return vs sd }

plot_ly(apal.port.agg, x = ~sd, 
                      y = ~avg_returns, 
                      color = ~factor(geno),
                      hoverinfo = "text", 
                      text = ~paste0("Geno: ", geno, "<br>",
                                     "Observations: ", observations, "<br>",
                                    "Average Return: ", round(avg_returns,3), "<br>",
                                    "Standard Deviation: ", round(sd, 3))) %>%
                    add_markers(size = ~observations) %>%
                    layout(xaxis = list(title = "Standard Deviation"),
                           yaxis = list(title = "Average Returns"),
                           title = "How Risk and Return Are Related") %>%
                    hide_legend()

# Reviewing distribution of returns for each geno with trelliscope.
# apal.port %>% ggplot(aes(x = returns)) + geom_histogram() + facet_trelliscope(~geno)

```

#### Apal Bootstrapping

In accordance with the Central Limit Theorem, the bootstrapped data approaches a normal distribution.  Thus, the distribution of returns closely resemble the sample means and the risk factors (standard deviations) used for portfolio analysis are more closely representative of the population.

<br>

```{r apal bootstrapping portfolio}

# Creating bootstrap data set.
apal.boot <- replicate(n = 1000, simplify = FALSE, expr = {
  apal.port %>%
  group_by(geno) %>%
  slice_sample(prop = 1, replace = TRUE)
 }) %>%
  bind_rows()

# Summarizing bootstrapped data by geno.
apal.boot.agg <- apal.boot %>%
  summarize(avg_health = mean(weighted_health),
         avg_mortality = mean(mortality_rate),
         avg_returns = mean(returns),
         sd = sd(returns),
         observations = n())

```


**Summary of Raw Data**
```{r apal portfolio raw table}
# Raw data summary
print(summary(apal.port.agg[,4:6]))

```

**Summary of Bootstrapped Data**
```{r apal portfolio bootstrap table}

# Boostrapped data summary
summary(apal.boot.agg[,4:6])

# Checking for normal distribution.
#apal.boot %>% ggplot(aes(x = returns)) + geom_histogram() + facet_trelliscope(~geno)
  
```

#### Apal Portfolio

The same portfolio constraints and objectives are used for the Apal model.  The portfolio is constructed with a fully invested, long-only requirement; weights are set to a minimum of 1% and a maximum of 25%.

<br>

```{r apal portfolio analysis}

#Number of unique genos
#length(unique(apal.port$geno))

apal.returns.wide <- apal.boot %>%
  select(geno, returns) %>%
  group_by(geno) %>%
  mutate(row = row_number()) %>%
  pivot_wider(names_from = geno, values_from = returns) %>%
  select(-row)

apal.returns.wide <- as.ts(apal.returns.wide)
port_spec <- portfolio.spec(assets = colnames(apal.returns.wide))
port_spec <- add.constraint(portfolio = port_spec, type = "full_investment")
port_spec <- add.constraint(portfolio = port_spec, type = "long_only")
port_spec <- add.objective(portfolio = port_spec, type = "return", name = "mean")
port_spec <- add.objective(portfolio = port_spec, type = "risk", name = "StdDev")
port_spec <- add.constraint(portfolio = port_spec, type = "box",
                                  min = 0.01, max = 0.25, 
                                  indexnum = 2)

set.seed(2)
apal.opt <- optimize.portfolio(apal.returns.wide,
                          portfolio = port_spec,
                          optimize_method = "random",
                          search_size = 20000,
                          trace = TRUE)

# Visualizing results.
apal.opt
chart.Weights(apal.opt)
chart.RiskReward(apal.opt, risk.col = "StdDev", return.col = "mean", chart.assets = FALSE,
                 main = "Optimal Apal Portfolio")

```

The result of the optimized portfolio suggests that greater improvements to survival rate and risk can be made to Apal outplantings than with Acer.  The lower range of Apal survival rates and the greater range in risk allows for a higher degree of optimization to be realized.  

<br>

```{r apal portfolio improvements}

apal.opt.table <- c(apal.opt$opt_values$mean, apal.opt$opt_values$StdDev[1])

apal.comparison <- apal.boot.agg %>%
  summarize(mean = mean(avg_returns),
            StdDev = mean(sd)) %>%
  bind_rows(apal.opt.table) %>%
  t() %>% 
  as.tibble() %>%
  mutate(change = abs(V2 - V1))

apal.comparison <- as.data.frame(apal.comparison)
colnames(apal.comparison) <- c("Current Portfolio", "Optimal Portfolio", "Improvement")
rownames(apal.comparison) <- c("Apal Survival Rate", "Apal Risk")
apal.comparison <- round(apal.comparison, 4) * 100

kable(apal.comparison)

```


## Conclusion

If greater efficiencies are to be achieved in reef restoration, managing genomic diversity must be done in step with the management of resources.  The genomic portfolio I propose is a method though which organizations can optimize outplantings with a greater level of success, given a desired genomic diversity.  The models above show that improvements to survival rates are possible with decreased risk.  The models do not consider secondary factors such as growth rates and natural reproduction cycles of each species.  If developed, this information could potentially yield another dimension to support long-term restoration strategies.  While more research is needed in data collection and model tuning, a 1% improvement today has the potential to grow exponentially.  As in finance, coral restoration organizations have the ability to build upon realized gains.  




