---
title: "Analysis of Coral Restoration Efforts"
subtitle: "A Collaboration with Reef Renewal Bonaire"
author: "Tadge McWilliams"
date: "2023-09-30"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r global settings, setup, include=FALSE}
library(knitr) #global settings
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r, load libraries, include=FALSE}
library(readxl)
library(tidyverse)
library(pander)
library(flextable)
library(rempsyc)
library(RColorBrewer)
```

```{r, loading data}
setwd("~/Documents/Data Science/Reef Renewal Bonaire")

###Monitoring Summary
ltsummary <- read_excel("Monitoring Summary.xlsx", 
                    sheet = 4, 
                    range = 'A3:N24',
                    col_names = c("site_name", "site_code", "species", "op_date", "subsite", 
                                  "survey_date","duration", "time_code", "eco_footprint",
                                  "tot_coral_area", "restored_area", "perc_coral_cover", 
                                  "coral_density", "restored_size_cm"))

##### Acer Data
# Mi Dushi I Survey
midushi13 <- read_excel("Mi Dushi I Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q71',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor"))

# Punt Vierkant 3-Month Survey
puntv3 <- read_excel("PV_Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'A2:Y92',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))

# Punt Vierkant 6-Month Survey
puntv6 <- read_excel("PV_Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:Y92',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))

# Yellowman A 3-Month Survey
yellowmanA3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q136',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "pred_stressor"))

# Yellowman A 6-Month Survey
yellowmanA6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'A2:P120',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                        "n_outplanted","n_present", "n_lost", "health_0",
                                        "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                        "avg_health", "pred_stressor"))

# Yellowman B 3-Month Survey
yellowmanB3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 4, 
                    range = 'A2:Y83',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))

# Yellowman B 6-Month Survey
yellowmanB6 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 5, 
                    range = 'A2:Z82',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", "bottom_contact", 
                                  "fireworm", "snail", "cyanob", "competition", "unknown", "n_stressors"))

# Yellowman C 3-Month Survey
yellowmanC3 <- read_excel("Yellowman Acer Monitoring Database.xlsx", 
                    sheet = 6, 
                    range = 'A2:Z34',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "rm_by_dead", "disease", "ciliate", 
                                  "bottom_contact", "fireworm", "snail", "cyanob", "competition", "unknown",
                                  "n_stressors"))

#### Apal Data
# Carl 3-Month Survey
carl3 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 2, 
                    range = 'A2:Y86',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "perc_dead_tissue", "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cliona", "competition", "unknown", "none", "n_stressors"))

# Carl 6-Month Survey
carl6 <- read_excel("Carls Hill Monitoring Database.xlsx", 
                    sheet = 3, 
                    range = 'A2:Z51',
                    col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "cyanob", "sedimentation", "unknown", "n_stressors"))

# Knife A 3-Month Survey
knifeA3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Knife A 5-Month Survey
knifeA5 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Knife A 6-Month Survey
knifeA6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 4, 
                          range = 'C2:Q39',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Knife B 3-Month Survey
knifeB3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 5, 
                          range = 'C2:Q124',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Knife B 6-Month Survey
knifeB6 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                          sheet = 6, 
                          range = 'C2:Q115',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Knife C 3-Month Survey
knifeC3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                    sheet = 7, 
                    range = 'A2:Z86',
                    col_names = c("date", "bond", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "competition", "sedimentation", "unknown", "n_stressors"))

# Knife C 6-Month Survey
knifeC3 <- read_excel("Knife I Apal Monitoring Database.xlsx", 
                    sheet = 8, 
                    range = 'A2:Z86',
                    col_names = c("date", "bond", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "rm_rank", "perc_dead_tissue", "perc_rm_clust", 
                                  "disease", "ciliate", "bottom_contact", "fireworm",
                                  "snail", "competition", "sedimentation", "unknown", "n_stressors"))

# Oil Slick 1-Month Survey
oilslick1 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Oil Slick 7-Month Survey
oilslick7 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# Oil Slick 13-Month Survey
oilslick13 <- read_excel("Oil Slick Monitoring Database.xlsx", 
                          sheet = 4, 
                          range = 'C2:Q29',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# South Bay II .5-Month Survey
southbay0.5 <- read_excel("South Bay II Monitoring Database.xlsx", 
                          sheet = 2, 
                          range = 'C2:Q67',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))

# South Bay II 18-Month Survey
southbay18 <- read_excel("South Bay II Monitoring Database.xlsx", 
                          sheet = 3, 
                          range = 'C2:Q71',
                          col_names = c("date", "duration", "species", "geno", "cluster", 
                                  "n_outplanted","n_present", "n_lost", "health_0",
                                  "health_q1", "health_q2", "health_q3", "health_q4", "health_100",
                                  "pred_stressor"))
```


```{r creating functions}

# Calculating average tissue health function.
tissue_health <- function(x) {
x %>%
  select(species, geno, n_outplanted, n_present, health_0, health_q1, health_q2, health_q3, health_q4, health_100) %>%
  rowwise() %>%
  mutate(Health0 = sum(health_0, na.rm = TRUE),
         Health25 = sum(health_q1 * 0.125, na.rm = TRUE),
         Health50 = sum(health_q2 * 0.375, na.rm = TRUE),
         Health75 = sum(health_q3 * 0.625, na.rm = TRUE),
         Health99 = sum(health_q4 * 0.87, na.rm = TRUE),
         Health100 = sum(health_100, na.rm = TRUE),
         weighted_health = (sum(Health25 + Health50 + Health75 + 
                                  Health99 + Health100, na.rm = TRUE) / (n_present - Health0)) * 100) %>%
  drop_na(weighted_health)
}

# Calculating aggregate table function.  Must take tissue_health function input.
agg_table <- function(x) {
x %>%
    group_by(species, geno) %>%
    summarize(num_outplanted = sum(n_outplanted),
              num_survived = sum(n_present, na.rm = TRUE) - sum(health_0, na.rm=TRUE),
              mortality_rate = 100 - sum(num_survived / num_outplanted)*100,
              avg_health = mean(weighted_health)) %>%
    arrange(mortality_rate)
}

# Creating ggplot function for mortality rate plot.
gg_mortality <- function(x) {
ggplot(x, aes(x=factor(geno), y=mortality_rate, fill= factor(geno))) +
  geom_col() +
  scale_y_continuous(limits = c(-10,80), labels=scales::percent_format(scale=1)) +
  labs(x="Genotype", 
       y="Mortality Rate",
       fill="Genotype") + 
  theme(legend.position = "none")
}

# Creating ggplot function for average tissue health plot.
gg_tissue_health <- function(x) {
  ggplot(x, aes(x = factor(geno), y = weighted_health)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5)) +
  labs(x = "Apal Genotype", 
       y = "Percent of Healthy Tissue") + 
    theme(plot.title = element_text(face = "italic"))
}

#Creating function for nice_table formatting. Input must be the aggregate object.
table_format <- function(x) {
x$mortality_rate <- paste0(round(x$mortality_rate, 2), "%")
x$avg_health <- paste0(round(x$avg_health, 2), "%")
x %>% rename("Species" = species, 
                       "Geno" = geno, 
                       "# Outplanted" = num_outplanted, 
                       "# Survived" = num_survived, 
                       "Mortality Rate" = mortality_rate,
                       "Avg. Health" = avg_health) %>% 
  colformat_num(digits = 1)
}

```


![](/Users/tadgemcwilliams/Documents/Data Science/Reef Renewal Bonaire/RRFB/Carl's Hill_IG.jpg)

## Summary

## Methodology

This analysis is intended to adhere to the guidance proposed by the National Oceanic & Atmospheric Association (NOAA) in its September 2020 technical memorandum *Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local Ecosystem Scales.* All data was provided by RRB.  The ecological footprint data was collected from photomosaics and traditional underwater surveying methods.  The site-specific data was provided after detailed surveys of the outplanted sites.  
Mortality rates are a standard calculation of (corals present - dead corals) / corals outplanted.  Average tissue health is calculated as a weighted average of five tissue-health categories.  Corals are partitioned into tissue health groups of 1-25%, 26-50%, 51-75%, 76-99%, and 100%.  The central point of each category (12.5%, 37.5%, 62.5%, 87%, and 100%) is used to calculate the average tissue health.  This calculation does not include dead observations or those with 0% tissue health.[^1]
All calculations and visualizations are performed using R.  R packages for this project include *knitr*, *readxl*, *tidyverse*, *flextable*, and *rempsyc*.  The report is formatted in Markdown, and all versions have been pushed to a GitHub repository.

[^1]: Goergen, E.A., Schopmeyer, S., Moulding, A.L., Moura, A., Kramer, P., and Viehman, T.S. 2020. Coral Reef Restoration Monitoring Guide: Methods to Evaluate Restoration Success From Local to Ecosystem Scales. NOAA Technical Memorandum NOS NCCOS 279. Silver Spring, MD. 158 pp. https://doi.org/10.25923/xndz-h538

## Overview of Restoration Efforts

## Species: Acer
Mi Dushi I: 13-month
Punt Vierkant: 3-month, 6-month
Yellowman A: 3-month, 6-month
Yellowman B: 3-month, 6-month
Yellowman C: 3-month

## Species: Apal
Carl’s Hill: 3-month, 6-month
Knife I A: 1-month, 5-month, 6-month
Knife I B: 3-month, 6-month
Knife I C: 3-month, 6-month
Oil Slick: 1-month, 7-month, 13-month
Southbay II: 0.5-month, 18-month

## Actionable Opportunities
Glue: Cement vs Epoxy

## Conclusions
